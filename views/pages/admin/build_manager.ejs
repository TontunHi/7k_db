<!DOCTYPE html>
<html lang="en">

<head>
    <%- include('../../partials/head') %>
        <link rel="stylesheet" href="/css/pages/admin/build_manager.css">
</head>

<body class="text-light">

    <nav class="navbar-modern">
        <div class="d-flex align-items-center">
            <img src="/images/about_website/logo_seven_knights_rebirth.png" alt="Logo" class="site-logo">
            <span class="nav-brand-text">7K Rebirth <span style="font-weight:400; opacity:0.7;">| Build
                    Manager</span></span>
            <span class="nav-badge">
                <%= grade.toUpperCase() %>
            </span>
        </div>
        <div class="d-flex align-items-center gap-3">
            <a href="/admin/dashboard" class="nav-btn primary">
                <i class="bi bi-grid-fill"></i> Dashboard
            </a>
            <a href="/admin/logout" class="nav-btn">
                <i class="bi bi-box-arrow-right"></i> Logout
            </a>
        </div>
    </nav>

    <div class="build-layout">
        <div class="hero-panel">
            <div class="hero-search-box">
                <input type="text" class="search-input" placeholder="Search Hero..." id="searchHero">
            </div>
            <div class="hero-list" id="heroListContainer">
                <% heroes.forEach(hero=> { %>
                    <div class="hero-item" onclick="selectHero('<%= hero.filename %>', '<%= hero.name %>')"
                        data-name="<%= hero.name.toLowerCase() %>">
                        <img src="/images/heroes/<%= hero.filename %>">
                        <div>
                            <div class="fw-bold text-white" style="font-size: 0.9rem;">
                                <%= hero.name %>
                            </div>
                        </div>
                    </div>
                    <% }) %>
            </div>
        </div>

        <div class="build-panel" id="buildPanel">
            <div id="emptyState"
                class="d-flex flex-column align-items-center justify-content-center h-100 text-white opacity-50">
                <i class="bi bi-person-gear display-1 mb-4"></i>
                <h5>Select a Hero to manage builds</h5>
            </div>

            <div id="editorContent" style="display: none;">
                <div class="d-flex justify-content-between align-items-center mb-4 sticky-top pt-2 pb-3"
                    style="background: #121212; z-index: 10; border-bottom: 1px solid #222;">
                    <div class="d-flex align-items-center gap-3">
                        <img id="headerHeroImg" src=""
                            style="width: 45px; aspect-ratio: 1; object-fit: contain; border-radius: 6px; border: 1px solid #555;">
                        <div>
                            <h4 id="selectedHeroName" class="m-0 text-white">Hero Name</h4>
                            <small class="text-secondary">Manage recommended items & stats</small>
                        </div>
                    </div>
                    <button class="btn btn-warning btn-sm fw-bold px-3 shadow-sm" onclick="createBuildCard(null, true)">
                        <i class="bi bi-plus-lg"></i> Add Build
                    </button>
                </div>

                <div id="buildsContainer">
                </div>

                <div style="height: 50px;"></div>
            </div>
        </div>
    </div>

    <!-- Global Image Picker Modal (Improved UI) -->
    <div class="modal fade" id="imagePickerModal" tabindex="-1" aria-hidden="true" data-bs-backdrop="static">
        <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable modal-lg">
            <div class="modal-content dark-theme">
                <div class="modal-header dark-theme border-0 pb-0">
                    <h5 class="modal-title fw-bold text-warning" id="pickerTitle">Select Image</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"
                        aria-label="Close"></button>
                </div>
                <!-- Sticky Search Section -->
                <div class="modal-body pt-0 custom-scrollbar">
                    <div class="sticky-search">
                        <div class="input-group">
                            <span class="input-group-text bg-dark border-secondary text-secondary"><i
                                    class="bi bi-search"></i></span>
                            <input type="text" class="form-control form-control-dark" id="gallerySearch"
                                placeholder="Search by name..." autocomplete="off">
                        </div>
                    </div>

                    <div class="hero-grid" id="modalGalleryContent">
                        <!-- Images injected here -->
                    </div>
                </div>
                <div class="modal-footer dark-theme border-0 pt-0">
                    <button type="button" class="btn btn-secondary btn-sm" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary-custom btn-sm d-none" id="btnMultiConfirm">Confirm
                        Selection</button>
                </div>
            </div>
        </div>
    </div>

    <template id="buildCardTemplate">
        <div class="build-card" data-id="">
            <button class="btn-delete-card" onclick="deleteBuild(this)" title="Delete Build"><i
                    class="bi bi-trash"></i></button>

            <div class="row g-3 mb-4 align-items-end">
                <div class="col-md-5">
                    <label class="label-mini">Build Name</label>
                    <input type="text" class="input-mini field-name" placeholder="e.g. PVP Speed Meta">
                </div>
                <div class="col-md-7 d-flex gap-3 align-items-end">
                    <div>
                        <label class="label-mini">C Level</label>
                        <select class="input-mini field-clevel" style="width:auto;">
                            <option value="C0">C0</option>
                            <option value="C1">C1</option>
                            <option value="C2">C2</option>
                            <option value="C3">C3</option>
                            <option value="C4">C4</option>
                            <option value="C5">C5</option>
                            <option value="C6">C6</option>
                        </select>
                    </div>
                    <div>
                        <div class="segment-box field-mode">
                            <input type="radio" name="md_TMP" value="PVE" checked><label>PVE</label>
                            <input type="radio" name="md_TMP" value="PVP"><label>PVP</label>
                            <input type="radio" name="md_TMP" value="PVE&PVP"><label>PVE&PVP</label>
                        </div>
                    </div>
                </div>
            </div>

            <div class="item-grid">
                <div class="item-box">
                    <div class="img-picker" onclick="openPicker(this, 'weapon')">
                        <i class="bi bi-plus-lg"></i>
                        <img src="" class="d-none preview-img">
                        <input type="hidden" class="field-w1-img">
                    </div>
                    <div class="flex-grow-1">
                        <label class="label-mini" style="color:#ffc107;">Weapon</label>
                        <select class="select-mini field-w1-stat">
                            <% const wStats=[ 'Weakness Hit Chance' , 'Crit Rate' , 'Crit Damage' , 'All Attack (%)'
                                , 'All Attack' , 'Defense (%)' , 'Defense' , 'HP (%)' , 'HP' , 'Effect Hit Rate' ]; %>
                                <% wStats.forEach(s=> { %><option value="<%= s %>">
                                        <%= s %>
                                    </option>
                                    <% }) %>
                        </select>
                    </div>
                </div>
                <div class="item-box">
                    <div class="img-picker" onclick="openPicker(this, 'armor')">
                        <i class="bi bi-plus-lg"></i>
                        <img src="" class="d-none preview-img">
                        <input type="hidden" class="field-a1-img">
                    </div>
                    <div class="flex-grow-1">
                        <label class="label-mini" style="color:#4fc3f7;">Armor</label>
                        <select class="select-mini field-a1-stat">
                            <% const aStats=[ 'Damage Taken Reduction' , 'Block Rate' , 'All Attack (%)' , 'All Attack'
                                , 'Defense (%)' , 'Defense' , 'HP (%)' , 'HP' , 'Effect Resistance' ]; %>
                                <% aStats.forEach(s=> { %><option value="<%= s %>">
                                        <%= s %>
                                    </option>
                                    <% }) %>
                        </select>
                    </div>
                </div>
                <div class="item-box">
                    <div class="img-picker" onclick="openPicker(this, 'weapon')">
                        <i class="bi bi-plus-lg"></i>
                        <img src="" class="d-none preview-img">
                        <input type="hidden" class="field-w2-img">
                    </div>
                    <div class="flex-grow-1">
                        <label class="label-mini" style="color:#ffc107;">Weapon</label>
                        <select class="select-mini field-w2-stat">
                            <% wStats.forEach(s=> { %><option value="<%= s %>">
                                    <%= s %>
                                </option>
                                <% }) %>
                        </select>
                    </div>
                </div>
                <div class="item-box">
                    <div class="img-picker" onclick="openPicker(this, 'armor')">
                        <i class="bi bi-plus-lg"></i>
                        <img src="" class="d-none preview-img">
                        <input type="hidden" class="field-a2-img">
                    </div>
                    <div class="flex-grow-1">
                        <label class="label-mini" style="color:#4fc3f7;">Armor</label>
                        <select class="select-mini field-a2-stat">
                            <% aStats.forEach(s=> { %><option value="<%= s %>">
                                    <%= s %>
                                </option>
                                <% }) %>
                        </select>
                    </div>
                </div>
            </div>

            <div class="mb-3">
                <label class="text-secondary small mb-2 fw-bold">Accessories (Max 5)</label>
                <div class="d-flex align-items-center gap-3 p-2 bg-dark rounded border border-secondary">
                    <div class="img-picker" onclick="openPicker(this, 'accessories', true)"
                        style="width: 45px; height: 45px;">
                        <i class="bi bi-plus-lg" style="font-size: 1rem;"></i>
                    </div>
                    <div class="acc-preview-list flex-grow-1 d-flex flex-wrap gap-2"></div>
                    <input type="hidden" class="field-acc">
                </div>
            </div>

            <div class="mb-3">
                <label class="text-secondary small mb-2 fw-bold">Sub Stats Priority</label>
                <div class="chip-container field-substats-container">
                    <% const subStats=[ 'All Attack (%)' , 'All Attack' , 'Defense (%)' , 'Defense' , 'HP (%)' , 'HP'
                        , 'Speed' , 'Crit Rate' , 'Crit Damage' , 'Weakness Hit Chance' , 'Block Rate'
                        , 'Effect Hit Rate' , 'Effect Resistance' ]; %>
                        <% subStats.forEach(s=> { %>
                            <div class="chip">
                                <%= s %>
                            </div>
                            <% }) %>
                </div>
                <input type="hidden" class="field-substats-input">
            </div>

            <div class="mb-3">
                <input type="text" class="input-mini field-desc" placeholder="Note / Description (Optional)"
                    style="padding: 10px;">
            </div>

            <div class="text-end border-top border-secondary pt-3 mt-2" style="border-color: #222 !important;">
                <button class="btn btn-sm btn-success px-4 fw-bold shadow-sm" onclick="saveCard(this)"
                    style="background: #198754; border: none; font-size: 0.85rem; letter-spacing: 0.5px;">
                    <i class="bi bi-save me-1"></i> Save Changes
                </button>
            </div>
        </div>
    </template>

    <%- include('../../partials/footer') %>

        <!-- Data Injection safe from JS Syntax Errors -->
        <script id="data-builds" type="application/json"><%- JSON.stringify(buildsMap) %></script>
        <script id="data-item-images" type="application/json"><%- JSON.stringify(itemImages) %></script>

        <script>
            // Local Data Cache (Parsed from hidden JSON blocks)
            let buildsData = {};
            let itemImages = {};

            try {
                const rawBuilds = document.getElementById('data-builds').textContent;
                if (rawBuilds) buildsData = JSON.parse(rawBuilds);

                const rawImages = document.getElementById('data-item-images').textContent;
                if (rawImages) itemImages = JSON.parse(rawImages);
            } catch (e) {
                console.error("Failed to init data:", e);
            }

            let currentHeroFilename = null;
            let currentPickerTarget = null;
            let isMultiSelect = false;
            let selectedMultiImages = [];

            function selectHero(filename, name) {
                currentHeroFilename = filename;

                document.getElementById('selectedHeroName').innerText = name;
                document.getElementById('headerHeroImg').src = `/images/heroes/${filename}`;

                // --- FIX: ซ่อน Empty State ทันที ---
                document.getElementById('emptyState').classList.add('d-none');
                document.getElementById('emptyState').classList.remove('d-flex');

                document.getElementById('editorContent').style.display = 'block';

                document.querySelectorAll('.hero-item').forEach(el => el.classList.remove('active'));
                event.currentTarget.classList.add('active');

                const builds = buildsData[filename] || [];
                const container = document.getElementById('buildsContainer');
                container.innerHTML = '';

                if (builds.length === 0) {
                    createBuildCard(null, false);
                } else {
                    builds.forEach(b => createBuildCard(b, false));
                }

                const panel = document.getElementById('buildPanel');
                setTimeout(() => { panel.scrollTop = 0; }, 10);
            }

            function createBuildCard(data = null, scrollToBottom = false) {
                const template = document.getElementById('buildCardTemplate');
                const clone = template.content.cloneNode(true);
                const card = clone.querySelector('.build-card');
                const uid = Date.now() + Math.random().toString(36).substr(2, 5);

                // Fix Radios (Mode only)
                const fixRadios = (tmpName, realName, val) => {
                    card.querySelectorAll(`input[name="${tmpName}"]`).forEach(r => {
                        const newId = `${realName}_${r.value}_${uid}`;
                        r.name = `${realName}_${uid}`;
                        r.id = newId;
                        r.nextElementSibling.setAttribute('for', newId);
                        if (val && r.value === val) r.checked = true;
                    });
                };
                fixRadios('md_TMP', 'mode', data?.mode || 'PVE');

                // Fill Inputs
                if (data) {
                    card.dataset.id = data.id;
                    card.querySelector('.field-name').value = data.build_name || '';
                    card.querySelector('.field-desc').value = data.description || '';

                    // Set C-Level (Dropdown)
                    card.querySelector('.field-clevel').value = data.c_level || 'C0';

                    card.querySelector('.field-w1-stat').value = data.weapon1_stat;
                    card.querySelector('.field-a1-stat').value = data.armor1_stat;
                    card.querySelector('.field-w2-stat').value = data.weapon2_stat;
                    card.querySelector('.field-a2-stat').value = data.armor2_stat;

                    setImgInput(card.querySelector('.field-w1-img'), data.weapon1_img, 'items/weapon');
                    setImgInput(card.querySelector('.field-a1-img'), data.armor1_img, 'items/armor');
                    setImgInput(card.querySelector('.field-w2-img'), data.weapon2_img, 'items/weapon');
                    setImgInput(card.querySelector('.field-a2-img'), data.armor2_img, 'items/armor');

                    const accInput = card.querySelector('.field-acc');
                    accInput.value = (data.accessories || []).join(',');
                    updateAccPreview(accInput, data.accessories || []);
                }

                // Chips
                const chipContainer = card.querySelector('.field-substats-container');
                const chips = chipContainer.querySelectorAll('.chip');
                const hiddenSub = card.querySelector('.field-substats-input');
                let selectedStats = data ? (data.substats || []) : [];

                const updateChips = () => {
                    chips.forEach(c => {
                        c.classList.remove('selected');
                        const idx = selectedStats.indexOf(c.innerText);
                        if (idx > -1) c.classList.add('selected');
                    });
                    hiddenSub.value = JSON.stringify(selectedStats);
                };

                chips.forEach(c => {
                    c.addEventListener('click', () => {
                        const txt = c.innerText;
                        const idx = selectedStats.indexOf(txt);
                        if (idx > -1) selectedStats.splice(idx, 1);
                        else selectedStats.push(txt);
                        updateChips();
                    });
                });
                updateChips();

                document.getElementById('buildsContainer').appendChild(card);

                if (scrollToBottom) {
                    setTimeout(() => card.scrollIntoView({ behavior: 'smooth', block: 'center' }), 100);
                }
            }

            function setImgInput(input, filename, folder) {
                if (!filename) return;
                input.value = filename;
                const preview = input.parentElement.querySelector('.preview-img');
                const icon = input.parentElement.querySelector('i');
                preview.src = `/images/${folder}/${filename}`;
                preview.classList.remove('d-none');
                icon.classList.add('d-none');
            }

            // --- Picker Logic ---
            const modal = new bootstrap.Modal(document.getElementById('imagePickerModal'));
            const galleryContent = document.getElementById('modalGalleryContent');
            const gallerySearch = document.getElementById('gallerySearch');
            const btnMultiConfirm = document.getElementById('btnMultiConfirm');

            window.openPicker = function (el, type, multi = false) {
                currentPickerTarget = el;
                isMultiSelect = multi;
                gallerySearch.value = '';

                let images = [];
                let folder = '';
                if (type === 'weapon') { images = itemImages.weapons; folder = 'items/weapon'; }
                else if (type === 'armor') { images = itemImages.armors; folder = 'items/armor'; }
                else { images = itemImages.accessories; folder = 'items/accessories'; }

                console.log(`Opening picker for ${type}. Found ${images ? images.length : 0} images.`);

                if (multi) {
                    btnMultiConfirm.classList.remove('d-none');
                    const hiddenVal = el.parentElement.querySelector('.field-acc').value;
                    selectedMultiImages = hiddenVal ? hiddenVal.split(',') : [];
                } else {
                    btnMultiConfirm.classList.add('d-none');
                    selectedMultiImages = [];
                }

                renderGallery(images, folder);
                modal.show();

                setTimeout(() => gallerySearch.focus(), 500);

                gallerySearch.onkeyup = (e) => {
                    const term = e.target.value.toLowerCase();
                    const filtered = images.filter(img => img.toLowerCase().includes(term));
                    renderGallery(filtered, folder);
                };
            }

            function renderGallery(images, folder) {
                galleryContent.innerHTML = '';
                images.forEach(img => {
                    const div = document.createElement('div');
                    div.className = 'gallery-item';
                    if (isMultiSelect && selectedMultiImages.includes(img)) div.classList.add('selected');
                    div.innerHTML = `<img src="/images/${folder}/${img}">`;
                    div.onclick = () => {
                        if (isMultiSelect) {
                            if (selectedMultiImages.includes(img)) {
                                selectedMultiImages = selectedMultiImages.filter(i => i !== img);
                                div.classList.remove('selected');
                            } else {
                                if (selectedMultiImages.length >= 5) return alert('Max 5 accessories');
                                selectedMultiImages.push(img);
                                div.classList.add('selected');
                            }
                        } else {
                            selectImageSingle(img, folder);
                        }
                    };
                    galleryContent.appendChild(div);
                });
            }

            function selectImageSingle(filename, folder) {
                const input = currentPickerTarget.querySelector('input');
                const preview = currentPickerTarget.querySelector('.preview-img');
                const icon = currentPickerTarget.querySelector('i');
                input.value = filename;
                preview.src = `/images/${folder}/${filename}`;
                preview.classList.remove('d-none');
                icon.classList.add('d-none');
                modal.hide();
            }

            btnMultiConfirm.onclick = () => {
                const input = currentPickerTarget.parentElement.querySelector('.field-acc');
                input.value = selectedMultiImages.join(',');
                updateAccPreview(input, selectedMultiImages);
                modal.hide();
            };

            function updateAccPreview(input, images) {
                const container = input.parentElement.querySelector('.acc-preview-list');
                container.innerHTML = '';
                images.forEach(img => {
                    if (!img) return;
                    const thumb = document.createElement('img');
                    thumb.src = `/images/items/accessories/${img}`;
                    thumb.className = 'acc-mini-thumb';
                    container.appendChild(thumb);
                });
            }

            window.saveCard = function (btn) {
                const card = btn.closest('.build-card');
                const uid = card.querySelector('input[type="radio"]').name.split('_').pop();
                const getRadio = (n) => card.querySelector(`input[name="${n}_${uid}"]:checked`)?.value;

                const payload = {
                    id: card.dataset.id || null,
                    hero_filename: currentHeroFilename,
                    build_name: card.querySelector('.field-name').value,

                    // Get C-Level from Select
                    c_level: card.querySelector('.field-clevel').value,

                    mode: getRadio('mode'),

                    weapon1_img: card.querySelector('.field-w1-img').value,
                    weapon1_stat: card.querySelector('.field-w1-stat').value,
                    armor1_img: card.querySelector('.field-a1-img').value,
                    armor1_stat: card.querySelector('.field-a1-stat').value,

                    weapon2_img: card.querySelector('.field-w2-img').value,
                    weapon2_stat: card.querySelector('.field-w2-stat').value,
                    armor2_img: card.querySelector('.field-a2-img').value,
                    armor2_stat: card.querySelector('.field-a2-stat').value,

                    accessories: card.querySelector('.field-acc').value.split(',').filter(x => x),
                    substats: JSON.parse(card.querySelector('.field-substats-input').value || '[]'),
                    description: card.querySelector('.field-desc').value
                };

                const originalHTML = btn.innerHTML;
                btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Saving...';

                const csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute('content');

                fetch('/admin/api/save_build', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'CSRF-Token': csrfToken
                    },
                    body: JSON.stringify(payload)
                })
                    .then(res => res.json())
                    .then(data => {
                        if (data.success) {
                            btn.innerHTML = '<i class="bi bi-check2-circle"></i> Saved';
                            btn.classList.replace('btn-success', 'btn-outline-success');

                            card.dataset.id = data.id;
                            payload.id = data.id;

                            if (!buildsData[currentHeroFilename]) buildsData[currentHeroFilename] = [];
                            const idx = buildsData[currentHeroFilename].findIndex(b => b.id == data.id);
                            if (idx > -1) buildsData[currentHeroFilename][idx] = payload;
                            else buildsData[currentHeroFilename].push(payload);

                            setTimeout(() => {
                                btn.innerHTML = originalHTML;
                                btn.classList.replace('btn-outline-success', 'btn-success');
                            }, 1500);
                        } else alert('Error: ' + data.error);
                    });
            }

            window.deleteBuild = function (btn) {
                if (!confirm('Delete this build?')) return;
                const card = btn.closest('.build-card');
                const id = card.dataset.id;

                card.remove();

                if (id) {
                    const csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute('content');
                    fetch('/admin/api/delete_build', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'CSRF-Token': csrfToken
                        },
                        body: JSON.stringify({ id })
                    });
                    if (buildsData[currentHeroFilename]) {
                        buildsData[currentHeroFilename] = buildsData[currentHeroFilename].filter(b => b.id != id);
                    }
                }
            }

            document.getElementById('searchHero').addEventListener('keyup', (e) => {
                const term = e.target.value.toLowerCase();
                document.querySelectorAll('.hero-item').forEach(el => {
                    el.style.display = el.dataset.name.includes(term) ? 'flex' : 'none';
                });
            });
        </script>
</body>

</html>