<!DOCTYPE html>
<html lang="en">

<head>
    <%- include('../../partials/head') %>
        <link rel="stylesheet" href="/css/pages/admin/dungeon_manager.css">
</head>

<body class="text-light">

    <nav class="navbar-modern">
        <div class="nav-brand-box">
            <img src="/images/about_website/logo_seven_knights_rebirth.png" alt="Logo" class="site-logo">
            <span class="nav-title">7K Rebirth <span style="font-weight:400; opacity:0.7;">| Dungeon
                    Manager</span></span>
        </div>
        <div class="d-flex align-items-center gap-3">
            <a href="/admin/dashboard" class="nav-btn primary"><i class="bi bi-grid-fill"></i> Panel</a>
            <a href="/admin/logout" class="nav-btn"><i class="bi bi-box-arrow-right"></i> Logout</a>
        </div>
    </nav>

    <div class="container main-content">
        <% dungeons.forEach(dungeon=> { %>
            <% let displayName=dungeon.banner .replace(/^\d+_/, '' ) .replace(/\.[^/.]+$/, '' ) .replace(/_/g, ' ' ); %>

                <div class="dungeon-card">
                    <div class="dungeon-banner-box">
                        <img src="/images/dungeon/<%= dungeon.banner %>" class="dungeon-banner-img">
                        <div class="banner-overlay">
                            <button class="btn btn-warning btn-sm fw-bold px-3 rounded-pill shadow-sm"
                                onclick="openAddTeamModal('<%= dungeon.banner %>', '<%= displayName %>')">
                                <i class="bi bi-plus-lg me-1"></i> Add Team
                            </button>
                        </div>
                    </div>

                    <% dungeon.teams.forEach(team=> { %>
                        <div class="team-row">
                            <div class="formation-block">
                                <img src="/images/formation/<%= team.formation %>.png">
                                <span>
                                    <%= team.formation %>
                                </span>
                            </div>

                            <div class="middle-content">
                                <div class="heroes-strip">
                                    <% let upIndices=[]; if(team.formation==='1-4' ) upIndices=[2]; else
                                        if(team.formation==='2-3' ) upIndices=[1, 3]; else if(team.formation==='3-2' )
                                        upIndices=[0, 2, 4]; else if(team.formation==='4-1' ) upIndices=[0, 1, 3, 4]; %>
                                        <% team.heroes.forEach((h, i)=> { %>
                                            <div class="hero-slot-sm <%= upIndices.includes(i) ? 'is-front' : '' %>">
                                                <% if(h) { %> <img src="/images/heroes/<%= h %>">
                                                    <% } %>
                                            </div>
                                            <% }) %>
                                </div>

                                <% if(team.description) { %>
                                    <div class="note-box">
                                        <i class="bi bi-card-text"></i>
                                        <span>
                                            <%= team.description %>
                                        </span>
                                    </div>
                                    <% } %>
                            </div>

                            <div class="action-btns">
                                <button class="btn-icon edit"
                                    onclick='editTeam(<%- JSON.stringify(team) %>, "<%= dungeon.banner %>", "<%= displayName %>")'
                                    title="Edit">
                                    <i class="bi bi-pencil-fill"></i>
                                </button>
                                <button class="btn-icon del" onclick="deleteTeam(<%= team.id %>)" title="Delete">
                                    <i class="bi bi-trash"></i>
                                </button>
                            </div>
                        </div>
                        <% }) %>

                            <% if(dungeon.teams.length===0) { %>
                                <div class="text-center py-4 text-white-50 small" style="background: #1a1a1a;">No teams
                                    added yet.</div>
                                <% } %>
                </div>
                <% }) %>
    </div>

    <div class="modal fade" id="compModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header border-secondary py-2">
                    <h6 class="modal-title fw-bold text-warning">Dungeon Team</h6>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body pt-4">
                    <form id="compForm">
                        <input type="hidden" name="id" id="compId">
                        <input type="hidden" name="dungeon_name" id="dungeonNameHidden">

                        <div class="mb-3 text-center">
                            <label class="modal-label">Selected Dungeon</label>
                            <input type="text" id="dungeonNameDisplay"
                                class="form-control form-control-sm input-dark text-center fw-bold fs-5" readonly
                                style="color: #ffc107; border: none; background: transparent;">
                        </div>

                        <div class="mb-3">
                            <label class="modal-label text-center mb-2">Formation</label>
                            <div class="formation-selector">
                                <% ['1-4', '2-3' , '3-2' , '4-1' ].forEach(fmt=> { %>
                                    <div class="form-option">
                                        <input type="radio" name="formation" id="fmt_<%= fmt %>" value="<%= fmt %>"
                                            <%=fmt=='1-4' ?'checked':'' %> onchange="updateHeroSlotsUI(this.value)">
                                        <label for="fmt_<%= fmt %>"><img src="/images/formation/<%= fmt %>.png">
                                            <div>
                                                <%= fmt %>
                                            </div>
                                        </label>
                                    </div>
                                    <% }) %>
                            </div>
                        </div>

                        <div class="mb-4">
                            <label class="modal-label text-center mb-0">Team</label>
                            <div class="hero-select-container">
                                <% for(let i=0; i<5; i++) { %>
                                    <div class="text-center">
                                        <div class="hero-input-slot" id="heroSlotContainer_<%= i %>"
                                            onclick="openHeroPicker(<%= i %>)">
                                            <img src="" id="heroPreview_<%= i %>" style="display: none;">
                                            <i class="bi bi-plus-lg text-secondary" id="heroPlaceholder_<%= i %>"></i>
                                        </div>
                                        <input type="hidden" name="heroes[]" id="heroInput_<%= i %>">
                                    </div>
                                    <% } %>
                            </div>
                        </div>

                        <div class="mb-2">
                            <label class="modal-label">Note</label>
                            <input type="text" name="description" id="compDesc" class="form-control input-dark"
                                placeholder="Optional note...">
                        </div>
                    </form>
                </div>
                <div class="modal-footer border-secondary py-2">
                    <button type="button" class="btn btn-secondary btn-sm" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-success btn-sm px-4" onclick="saveComp()">Save Team</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="heroPickerModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header border-secondary py-2">
                    <h6 class="modal-title">Select Hero</h6>
                    <input type="text" id="heroSearch"
                        class="form-control form-control-sm bg-dark text-light border-secondary ms-3"
                        style="width: 200px;" placeholder="Search...">
                </div>
                <div class="modal-body">
                    <div class="hero-picker-grid" id="heroGrid">
                        <% heroes.forEach(h=> { %>
                            <div class="picker-item" onclick="selectHero('<%= h.filename %>')"
                                data-name="<%= h.name.toLowerCase() %>">
                                <img src="/images/heroes/<%= h.filename %>" title="<%= h.name %>">
                            </div>
                            <% }) %>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <%- include('../../partials/footer') %>

        <script>
            const compModal = new bootstrap.Modal(document.getElementById('compModal'));
            const heroPickerModal = new bootstrap.Modal(document.getElementById('heroPickerModal'));
            let currentSlot = 0;

            function updateHeroSlotsUI(formation) {
                let frontIndices = [];
                switch (formation) {
                    case '1-4': frontIndices = [2]; break;
                    case '2-3': frontIndices = [1, 3]; break;
                    case '3-2': frontIndices = [0, 2, 4]; break;
                    case '4-1': frontIndices = [0, 1, 3, 4]; break;
                }

                for (let i = 0; i < 5; i++) {
                    const container = document.getElementById(`heroSlotContainer_${i}`);
                    const placeholder = document.getElementById(`heroPlaceholder_${i}`);
                    container.classList.remove('slot-front', 'slot-back');
                    placeholder.classList.remove('text-secondary');

                    if (frontIndices.includes(i)) container.classList.add('slot-front');
                    else container.classList.add('slot-back');
                }
            }

            function openAddTeamModal(dungeonName, displayName) {
                resetForm();
                document.getElementById('dungeonNameHidden').value = dungeonName;
                document.getElementById('dungeonNameDisplay').value = displayName;
                updateHeroSlotsUI('1-4'); // Default
                compModal.show();
            }

            // [NEW] Edit Function
            function editTeam(team, dungeonName, displayName) {
                resetForm();
                // Populate Data
                document.getElementById('compId').value = team.id;
                document.getElementById('dungeonNameHidden').value = dungeonName;
                document.getElementById('dungeonNameDisplay').value = displayName;
                document.getElementById('compDesc').value = team.description || '';

                // Set Formation
                document.querySelector(`input[name="formation"][value="${team.formation}"]`).checked = true;
                updateHeroSlotsUI(team.formation);

                // Set Heroes
                team.heroes.forEach((h, index) => {
                    if (index < 5) setHeroSlot(index, h);
                });

                compModal.show();
            }

            function resetForm() {
                document.getElementById('compForm').reset();
                document.getElementById('compId').value = '';
                document.getElementById('fmt_1-4').checked = true;
                for (let i = 0; i < 5; i++) setHeroSlot(i, '');
            }

            function saveComp() {
                const form = document.getElementById('compForm');
                const formData = new FormData(form);
                const payload = Object.fromEntries(formData);

                payload.heroes = [];
                for (let i = 0; i < 5; i++) {
                    payload.heroes.push(document.getElementById(`heroInput_${i}`).value);
                }

                const csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute('content');
                fetch('/admin/api/save_dungeon_comp', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'CSRF-Token': csrfToken
                    },
                    body: JSON.stringify(payload)
                })
                    .then(res => res.json())
                    .then(data => {
                        if (data.success) location.reload();
                        else alert('Error: ' + (data.error || 'Unknown error'));
                    });
            }

            function deleteTeam(id) {
                if (!confirm('Delete this team?')) return;
                const csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute('content');
                fetch('/admin/api/delete_dungeon_comp', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'CSRF-Token': csrfToken
                    },
                    body: JSON.stringify({ id })
                })
                    .then(res => res.json())
                    .then(data => {
                        if (data.success) location.reload();
                    });
            }

            function openHeroPicker(slotIndex) {
                currentSlot = slotIndex;
                heroPickerModal.show();
            }
            function selectHero(filename) {
                setHeroSlot(currentSlot, filename);
                heroPickerModal.hide();
            }
            function setHeroSlot(index, filename) {
                const input = document.getElementById(`heroInput_${index}`);
                const img = document.getElementById(`heroPreview_${index}`);
                const ph = document.getElementById(`heroPlaceholder_${index}`);

                input.value = filename || '';
                if (filename) {
                    img.src = `/images/heroes/${filename}`;
                    img.style.display = 'block';
                    ph.style.display = 'none';
                } else {
                    img.style.display = 'none';
                    ph.style.display = 'block';
                }
            }

            document.getElementById('heroSearch').addEventListener('keyup', function (e) {
                const term = e.target.value.toLowerCase();
                document.querySelectorAll('.picker-item').forEach(item => {
                    item.style.display = item.dataset.name.includes(term) ? 'block' : 'none';
                });
            });
        </script>
</body>

</html>