<!DOCTYPE html>
<html lang="en">
  <head>
    <%- include('../../partials/head') %>
    <style>
      /* --- Base Theme --- */
      body {
        background-color: #0f0f0f;
        color: #e0e0e0;
        padding-top: 80px;
        font-family: "Segoe UI", sans-serif;
      }

      ::-webkit-scrollbar {
        width: 6px;
        height: 6px;
      }

      ::-webkit-scrollbar-thumb {
        background: #444;
        border-radius: 3px;
      }

      /* --- Admin Navbar Style --- */
      .navbar-modern {
        height: 64px;
        background: rgba(18, 18, 18, 0.95);
        backdrop-filter: blur(10px);
        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        z-index: 1050;
        padding: 0 20px;
        display: flex;
        align-items: center;
        justify-content: space-between;
      }

      .nav-brand-text {
        font-weight: 700;
        color: #fff;
        font-size: 1.1rem;
      }

      .nav-btn {
        background: rgba(255, 255, 255, 0.05);
        color: #ccc;
        border: 1px solid rgba(255, 255, 255, 0.1);
        padding: 6px 16px;
        border-radius: 20px;
        font-size: 0.85rem;
        text-decoration: none;
        display: inline-flex;
        align-items: center;
        gap: 6px;
        transition: 0.2s;
      }

      .nav-btn:hover {
        background: rgba(255, 255, 255, 0.1);
        color: #fff;
      }

      /* --- Raid List (Vertical Banner Style) --- */
      .raid-list-container {
        max-width: 900px;
        margin: 0 auto;
      }

      .raid-card-vertical {
        background: #1e1e1e;
        border: 1px solid #333;
        border-radius: 12px;
        display: flex;
        align-items: center;
        padding: 0;
        margin-bottom: 20px;
        transition: all 0.2s;
        position: relative;
        overflow: hidden;
        cursor: pointer;
        height: 120px;
      }

      .raid-card-vertical:hover {
        transform: translateY(-3px);
        border-color: #ffc107;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
      }

      .raid-cover-full {
        width: 200px;
        height: 100%;
        object-fit: cover;
        border-right: 1px solid #333;
        mask-image: linear-gradient(to right, black 80%, transparent 100%);
      }

      .raid-info {
        flex: 1;
        padding: 20px;
        display: flex;
        flex-direction: column;
        justify-content: center;
      }

      .raid-title {
        font-size: 1.5rem;
        font-weight: 800;
        color: #fff;
        margin: 0;
        text-transform: uppercase;
        letter-spacing: 1px;
      }

      .raid-meta {
        color: #888;
        font-size: 0.9rem;
        margin-top: 5px;
      }

      /* .delete-btn-absolute removed - using flex .raid-actions instead */

      /* --- Team Detail --- */
      .page-header {
        background: #161616;
        padding: 20px 0;
        border-bottom: 1px solid #333;
        margin-bottom: 30px;
      }

      .team-card-item {
        background: #1e1e1e;
        border: 1px solid #333;
        border-radius: 8px;
        padding: 15px;
        display: flex;
        flex-direction: column;
        gap: 10px;
        transition: 0.2s;
      }

      .team-card-item:hover {
        border-color: #666;
        background: #222;
      }

      /* --- MODERN EDITOR MODAL --- */
      .modal-content {
        background: #121212;
        border: 1px solid #333;
      }

      .form-label-modern {
        color: #888;
        font-size: 0.75rem;
        font-weight: 700;
        text-transform: uppercase;
        letter-spacing: 1px;
        margin-bottom: 5px;
      }

      .input-modern {
        background: #000 !important;
        border: 1px solid #333 !important;
        color: #fff !important;
        border-radius: 6px;
      }

      /* Formation Selector */
      .formation-wrapper {
        display: flex;
        justify-content: center;
        gap: 15px;
        margin-bottom: 25px;
        flex-wrap: wrap;
      }

      .form-select-card {
        background: #1a1a1a;
        border: 2px solid #333;
        border-radius: 8px;
        padding: 8px;
        cursor: pointer;
        transition: 0.2s;
        text-align: center;
        width: 90px;
      }

      .form-select-card:hover {
        border-color: #666;
        background: #222;
      }

      .form-select-card.active {
        border-color: #ffc107;
        background: rgba(255, 193, 7, 0.05);
      }

      .form-img {
        width: 100%;
        height: auto;
        margin-bottom: 5px;
        opacity: 0.6;
      }

      .form-select-card.active .form-img {
        opacity: 1;
      }

      .form-name {
        font-size: 0.8rem;
        font-weight: bold;
        color: #aaa;
      }

      .form-select-card.active .form-name {
        color: #ffc107;
      }

      /* Battle Stage & Slots */
      .battle-stage {
        background: #1a1a1a;
        border-radius: 12px;
        border: 1px solid #333;
        padding: 40px 20px;
        margin-bottom: 20px;
        display: flex;
        justify-content: center;
        align-items: center;
        min-height: 220px;
        position: relative;
        background-image: radial-gradient(#2a2a2a 1px, transparent 1px);
        background-size: 20px 20px;
        gap: 10px;
      }

      .hero-row {
        display: flex;
        gap: 12px;
        align-items: center;
      }

      .hero-input-slot {
        width: 85px;
        height: 115px;
        background: #000;
        border-radius: 8px;
        border: 2px dashed #444;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        position: relative;
        transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.5);
      }

      .hero-input-slot:hover {
        border-color: #fff;
        transform: scale(1.05);
        z-index: 10;
      }

      .hero-input-slot img {
        width: 100%;
        height: 100%;
        object-fit: cover;
        border-radius: 6px;
      }

      .hero-input-slot.empty i {
        font-size: 1.5rem;
        color: #444;
      }

      /* Logic Positions */
      .hero-input-slot.slot-front {
        border-style: solid;
        border-color: #90caf9;
        transform: translateY(-20px);
      }

      .hero-input-slot.slot-back {
        border-style: solid;
        border-color: #ef9a9a;
      }

      /* --- Skill Priority (Updated) --- */
      .skill-section {
        background: #000;
        border: 1px solid #333;
        border-radius: 8px;
        padding: 15px;
      }

      .skill-matrix {
        display: flex;
        gap: 12px;
        overflow-x: auto;
        padding-bottom: 5px;
        justify-content: center;
      }

      .hero-col {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 4px;
      }

      /* Adjusted Skill Box Size */
      .skill-box {
        width: 35px;
        height: 35px;
        /* Reduced Size */
        border: 1px solid #333;
        border-radius: 4px;
        cursor: pointer;
        position: relative;
        overflow: hidden;
      }

      .skill-box img {
        width: 100%;
        height: 100%;
        object-fit: cover;
        opacity: 0.5;
        transition: 0.2s;
      }

      .skill-box:hover img {
        opacity: 1;
      }

      .skill-box.selected {
        border: 2px solid #ffc107;
      }

      .skill-box.selected img {
        opacity: 1;
      }

      .order-badge {
        position: absolute;
        top: 0;
        right: 0;
        background: #ffc107;
        color: #000;
        width: 14px;
        height: 14px;
        font-size: 9px;
        font-weight: bold;
        display: flex;
        align-items: center;
        justify-content: center;
        border-bottom-left-radius: 4px;
      }

      /* Hero Picker */
      .picker-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(90px, 1fr));
        gap: 10px;
      }

      .pick-item img {
        width: 100%;
        aspect-ratio: 3/4;
        object-fit: cover;
        border-radius: 6px;
        border: 2px solid transparent;
      }

      .pick-item:hover img {
        border-color: #ffc107;
        transform: scale(1.05);
      }
    </style>
  </head>

  <body class="text-light">
    <nav class="navbar-modern">
      <div class="d-flex align-items-center gap-3">
        <img
          src="/images/about_website/logo_seven_knights_rebirth.png"
          alt="Logo"
          style="height: 40px"
        />
        <span class="nav-brand-text"
          >7K Rebirth
          <span style="font-weight: 400; opacity: 0.7">| Admin</span></span
        >
      </div>
      <div class="d-flex align-items-center gap-3">
        <a href="/admin/dashboard" class="nav-btn"
          ><i class="bi bi-grid-fill"></i> Dashboard</a
        >
        <a href="/admin/logout" class="nav-btn"
          ><i class="bi bi-box-arrow-right"></i> Logout</a
        >
      </div>
    </nav>

    <% if (viewState==='list' ) { %>
    <div class="container py-5">
      <div
        class="d-flex justify-content-between align-items-center mb-4 raid-list-container"
      >
        <h3 class="fw-bold text-white">
          <i class="bi bi-list-stars me-2 text-warning"></i>RAID MANAGER
        </h3>
        <button
          class="btn btn-warning px-4 fw-bold shadow-sm rounded-pill"
          data-bs-toggle="modal"
          data-bs-target="#addRaidModal"
        >
          <i class="bi bi-plus-lg me-1"></i> New Raid
        </button>
      </div>

      <div class="raid-list-container">
        <% if(raids.length> 0) { %> <% raids.forEach(r=> { %>
        <div
          class="raid-card-vertical"
          onclick="window.location.href='/admin/manage/raid?raid_id=<%= r.id %>'"
        >
          <img src="/images/raid/<%= r.image_name %>" class="raid-cover-full" />
          <div class="raid-info">
            <h5 class="raid-title"><%= r.name %></h5>
            <span class="raid-meta"
              ><i class="bi bi-people-fill me-1"></i> Manage Teams &
              Formations</span
            >
          </div>

          <div
            class="raid-actions d-flex gap-2 align-items-center ms-auto me-4"
          >
            <button
              class="btn btn-sm btn-dark border-secondary text-warning"
              onclick="event.stopPropagation(); editRaidBoss(<%= JSON.stringify(r) %>)"
            >
              <i class="bi bi-pencil-fill"></i>
            </button>
            <form
              action="/admin/api/raid/delete_boss"
              method="POST"
              onclick="event.stopPropagation()"
              onsubmit="return confirm('Delete Raid: <%= r.name %>?');"
              style="display: inline"
            >
              <input type="hidden" name="id" value="<%= r.id %>" />
              <input type="hidden" name="_csrf" value="<%= csrfToken %>" />
              <button
                type="submit"
                class="btn btn-sm btn-dark border-secondary text-danger"
              >
                <i class="bi bi-trash"></i>
              </button>
            </form>
            <div class="vr bg-secondary mx-2"></div>
            <i class="bi bi-chevron-right text-muted fs-4"></i>
          </div>
        </div>
        <% }) %> <% } else { %>
        <div
          class="text-center py-5 text-muted border border-secondary border-dashed rounded bg-dark bg-opacity-25"
        >
          <i class="bi bi-inbox fs-1 d-block mb-3 opacity-50"></i>
          <h5>No Raid Bosses Found</h5>
        </div>
        <% } %>
      </div>
    </div>

    <div class="modal fade" id="addRaidModal" tabindex="-1">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-header border-secondary">
            <h5 class="modal-title text-white">Add Raid Boss</h5>
            <button
              type="button"
              class="btn-close btn-close-white"
              data-bs-dismiss="modal"
            ></button>
          </div>
          <form action="/admin/api/raid/add_boss" method="POST">
            <input type="hidden" name="_csrf" value="<%= csrfToken %>" />
            <div class="modal-body">
              <div class="mb-3">
                <label class="form-label text-muted">Boss Name</label>
                <input
                  type="text"
                  name="name"
                  class="form-control bg-black text-white border-secondary"
                  required
                />
              </div>
              <div class="mb-3">
                <label class="form-label text-muted">Image</label>
                <select
                  name="image_name"
                  class="form-select bg-black text-white border-secondary"
                >
                  <% if(availableRaidImages && availableRaidImages.length> 0) {
                  %> <% availableRaidImages.forEach(img=> { %>
                  <option value="<%= img %>"><%= img %></option>
                  <% }) %> <% } else { %>
                  <option value="" disabled>No images found</option>
                  <% } %>
                </select>
              </div>
            </div>
            <div class="modal-footer border-secondary">
              <button type="submit" class="btn btn-warning">Create</button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <% } else { %>
    <div class="page-header">
      <div class="container d-flex justify-content-between align-items-center">
        <div class="d-flex align-items-center gap-3">
          <a
            href="/admin/manage/raid"
            class="btn btn-outline-secondary rounded-circle"
            style="
              width: 40px;
              height: 40px;
              display: flex;
              align-items: center;
              justify-content: center;
            "
            ><i class="bi bi-arrow-left"></i
          ></a>
          <div class="d-flex align-items-center gap-3">
            <img
              src="/images/raid/<%= activeRaid.image_name %>"
              style="
                width: 50px;
                height: 50px;
                border-radius: 8px;
                object-fit: cover;
                border: 1px solid #444;
              "
            />
            <h3 class="m-0 fw-bold text-white"><%= activeRaid.name %></h3>
          </div>
        </div>
        <button
          class="btn btn-warning px-4 fw-bold rounded-pill shadow-sm"
          onclick="openEditor()"
        >
          <i class="bi bi-plus-lg me-2"></i>Add Team
        </button>
      </div>
    </div>

    <div class="container">
      <div class="row g-3">
        <% if(teams.length===0) { %>
        <div class="col-12 text-center py-5 text-muted">
          <h5>No teams created yet.</h5>
        </div>
        <% } %> <% teams.forEach((team, index)=> { %>
        <div class="col-md-6 col-lg-4">
          <div class="team-card-item">
            <div class="d-flex justify-content-between align-items-start">
              <h5 class="text-white m-0 fw-bold">
                <%= team.team_name || 'Untitled Team' %>
              </h5>
              <span class="badge bg-secondary"> <%= team.formation %> </span>
            </div>
            <div class="d-flex gap-1 mt-2">
              <% team.hero_ids.forEach(hid=> { %> <% let h=heroesMap[hid]; %> <%
              if(h) { %>
              <img
                src="/images/heroes/<%= h.image_name %>"
                style="
                  width: 80px;
                  height: 80px;
                  aspect-ratio: 3/4;
                  object-fit: cover;
                  border-radius: 3px;
                  border: 1px solid #444;
                "
              />
              <% } %> <% }) %>
            </div>
            <div class="d-flex align-items-center gap-2">
              <button
                class="btn btn-sm btn-outline-warning d-flex align-items-center gap-2"
                onclick="editTeam('<%= index %>')"
                style="border-radius: 20px; padding: 5px 15px"
              >
                <i class="bi bi-pencil-square"></i> <span>Edit</span>
              </button>

              <button
                class="btn btn-sm btn-outline-danger"
                onclick="deleteTeam('<%= team.id %>')"
                style="
                  border-radius: 50%;
                  width: 32px;
                  height: 32px;
                  padding: 0;
                  display: flex;
                  align-items: center;
                  justify-content: center;
                "
              >
                <i class="bi bi-trash"></i>
              </button>
            </div>
          </div>
        </div>
        <% }) %>
      </div>
    </div>

    <div
      class="modal fade"
      id="teamEditorModal"
      tabindex="-1"
      data-bs-backdrop="static"
    >
      <div class="modal-dialog modal-xl modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-header border-secondary">
            <h5 class="modal-title text-warning fw-bold" id="editorTitle">
              TEAM BUILDER
            </h5>
            <button
              type="button"
              class="btn-close btn-close-white"
              data-bs-dismiss="modal"
            ></button>
          </div>
          <div class="modal-body p-4">
            <div class="row g-3 mb-4">
              <div class="col-md-6">
                <label class="form-label-modern">Team Name</label>
                <input
                  type="text"
                  id="editName"
                  class="form-control input-modern"
                  placeholder="e.g. Best DPS Team"
                />
              </div>
              <div class="col-md-6">
                <label class="form-label-modern">Video Guide (URL)</label>
                <input
                  type="text"
                  id="editYoutube"
                  class="form-control input-modern"
                  placeholder="https://youtube.com/..."
                />
              </div>
            </div>

            <label class="form-label-modern text-center w-100 mb-2"
              >Select Formation</label
            >
            <div class="formation-wrapper">
              <% ['1-4', '2-3' , '3-2' , '4-1' ].forEach(fmt=> { %>
              <div
                class="form-select-card"
                id="form-card-<%= fmt %>"
                onclick="setFormation('<%= fmt %>')"
              >
                <img
                  src="/images/formation/<%= fmt %>.png"
                  class="form-img"
                  onerror="this.src='https://via.placeholder.com/50?text=F'"
                />
                <div class="form-name"><%= fmt %></div>
              </div>
              <% }) %>
            </div>

            <div class="battle-stage">
              <% for(let i=1; i<=5; i++) { %>
              <div
                class="hero-input-slot empty slot-back"
                id="slot-<%= i-1 %>"
                onclick="openPicker(<%= i-1 %>)"
              >
                <i class="bi bi-plus-lg"></i>
              </div>
              <% } %>

              <!-- Pet Slot -->
              <div class="hero-col">
                <label class="text-muted small mb-1">PET</label>
                <div
                  class="hero-input-slot empty"
                  id="slot-pet"
                  onclick="openPetPicker()"
                  style="
                  border-style: dashed; 
                  border-color: #ffd700;"
                >
                  <i class="bi bi-github text-warning"></i>
                </div>
              </div>
            </div>

            <div class="skill-section mb-3">
              <label class="form-label-modern w-100 text-center mb-3"
                >Skill Priority Sequence</label
              >
              <div id="skillMatrix" class="skill-matrix">
                <span class="text-muted small"
                  >Select heroes to configure skills</span
                >
              </div>
            </div>

            <div>
              <label class="form-label-modern">Description / Notes</label>
              <textarea
                id="editDesc"
                class="form-control input-modern"
                rows="2"
              ></textarea>
            </div>
          </div>
          <div class="modal-footer border-secondary">
            <button
              type="button"
              class="btn btn-outline-secondary"
              data-bs-dismiss="modal"
            >
              Cancel
            </button>
            <button
              type="button"
              class="btn btn-warning px-5 fw-bold"
              onclick="saveTeamData()"
            >
              Save Team
            </button>
          </div>
        </div>
      </div>
    </div>

    <div class="modal fade" id="heroPickerModal" tabindex="-1">
      <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content border-secondary">
          <div class="modal-header border-secondary py-2">
            <input
              type="text"
              id="heroSearch"
              class="form-control input-modern form-control-sm"
              placeholder="Search Hero File..."
              onkeyup="filterHeroes()"
            />
            <button
              type="button"
              class="btn-close btn-close-white ms-2"
              data-bs-dismiss="modal"
            ></button>
          </div>
          <div
            class="modal-body bg-black"
            style="height: 60vh; overflow-y: auto"
          >
            <div class="picker-grid">
              <% heroFiles.forEach(file=> { %>
              <div
                class="pick-item"
                data-name="<%= file.toLowerCase() %>"
                onclick="selectHero('<%= file %>')"
              >
                <img src="/images/heroes/<%= file %>" loading="lazy" />
                <small
                  class="d-block text-center text-muted mt-1 text-truncate"
                >
                  <%= file %>
                </small>
              </div>
              <% }) %>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Pet Picker Modal -->
    <div class="modal fade" id="petPickerModal" tabindex="-1">
      <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content border-secondary">
          <div class="modal-header border-secondary py-2">
            <input
              type="text"
              id="petSearch"
              class="form-control input-modern form-control-sm"
              placeholder="Search Pet..."
              onkeyup="filterPets()"
            />
            <button
              type="button"
              class="btn-close btn-close-white ms-2"
              data-bs-dismiss="modal"
            ></button>
          </div>
          <div
            class="modal-body bg-black"
            style="height: 60vh; overflow-y: auto"
          >
            <div class="picker-grid" id="petGrid">
              <% if(petFiles && petFiles.length> 0) { %> <% petFiles.forEach(p=>
              { %>
              <div
                class="pick-item pet-item"
                data-name="<%= p.toLowerCase() %>"
                onclick="selectPet('<%= p %>')"
              >
                <img src="/images/pets/<%= p %>" loading="lazy" />
                <small
                  class="d-block text-center text-muted mt-1 text-truncate"
                >
                  <%= p %>
                </small>
              </div>
              <% }) %> <% } else { %>
              <div class="col-12 text-center text-muted">No pets found</div>
              <% } %>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Data Injection -->
    <script id="heroes-map-data" type="application/json">
      <%- JSON.stringify(heroesMap || {}) %>
    </script>
    <script id="teams-data" type="application/json">
      <%- JSON.stringify(teams || []) %>
    </script>
    <script>
      // Data
      const activeRaidId = '<%= activeRaid ? activeRaid.id : "" %>';
      const heroesMap = JSON.parse(
        document.getElementById("heroes-map-data").textContent
      );
      const teamsData = JSON.parse(
        document.getElementById("teams-data").textContent
      );

      let currentTeamId = null;
      let currentFormation = "1-4";

      // ... (existing code)

      function editTeam(index) {
        const team = teamsData[index];
        if (!team) return;

        document.getElementById("editorTitle").innerText = "EDIT TEAM";
        currentTeamId = team.id;

        document.getElementById("editName").value = team.team_name;
        document.getElementById("editYoutube").value = team.youtube_link || "";

        setFormation(team.formation);

        // Clear slots
        for (let i = 0; i < 5; i++) clearSlot(i);

        // Fill slots
        if (team.hero_ids && Array.isArray(team.hero_ids)) {
          team.hero_ids.forEach((hid, i) => {
            if (i < 5 && hid) {
              setSlot(i, hid);
            }
          });
        }

        // Fill skills
        skillSequence = team.skill_priority || [];
        renderSkillMatrix();

        const modal = new bootstrap.Modal(
          document.getElementById("teamEditorModal")
        );
        modal.show();
      }

      // Old editTeam stub removed/replaced

      let teamSlots = [null, null, null, null, null];
      let currentPet = null; // [NEW] Track current pet
      let skillPriority = [];
      let pickingSlotIndex = -1;

      // --- Raid Boss Editor (New) ---
      const addRaidModal = new bootstrap.Modal(
        document.getElementById("addRaidModal")
      );

      function editRaidBoss(raid) {
        const form = document.querySelector("#addRaidModal form");
        form.action = "/admin/api/raid/edit_boss";

        document.querySelector("#addRaidModal .modal-title").innerText =
          "Edit Raid Boss";
        document.querySelector('#addRaidModal [name="name"]').value = raid.name;
        document.querySelector('#addRaidModal [name="image_name"]').value =
          raid.image_name;

        // Add hidden ID input if not exists
        let idInput = form.querySelector('input[name="id"]');
        if (!idInput) {
          idInput = document.createElement("input");
          idInput.type = "hidden";
          idInput.name = "id";
          form.appendChild(idInput);
        }
        idInput.value = raid.id;

        document.querySelector(
          '#addRaidModal button[type="submit"]'
        ).innerText = "Save Changes";
        addRaidModal.show();
      }

      // Reset modal on close/open new
      document
        .getElementById("addRaidModal")
        .addEventListener("hidden.bs.modal", function () {
          const form = this.querySelector("form");
          form.action = "/admin/api/raid/add_boss";
          form.reset();
          this.querySelector(".modal-title").innerText = "Add Raid Boss";
          const idInput = form.querySelector('input[name="id"]');
          if (idInput) idInput.remove();
          this.querySelector('button[type="submit"]').innerText = "Create";
        });

      // --- Editor ---
      // --- Editor ---
      function openEditor() {
        currentTeamId = null;
        document.getElementById("editorTitle").innerText = "CREATE NEW TEAM";
        teamSlots = [null, null, null, null, null];
        currentPet = null; // Reset Pet
        skillPriority = [];
        currentFormation = "1-4";
        document.getElementById("editName").value = "";
        document.getElementById("editYoutube").value = "";
        document.getElementById("editDesc").value = "";
        setFormation("1-4");
        renderPetSlot(); // Update UI
        // Clear visuals
        for (let i = 0; i < 5; i++) {
          const el = document.getElementById(`slot-${i}`);
          if (el) {
            el.innerHTML = `<i class="bi bi-plus-lg"></i>`;
            el.classList.add("empty");
          }
        }
        renderSkillMatrix();
        new bootstrap.Modal(document.getElementById("teamEditorModal")).show();
      }

      function editTeam(index) {
        const team = teamsData[index];
        if (!team) return;

        currentTeamId = team.id;
        document.getElementById("editorTitle").innerText = "EDIT TEAM";

        currentFormation = team.formation || "1-4";
        document.getElementById("editName").value = team.team_name || "";
        document.getElementById("editYoutube").value = team.youtube_link || "";
        document.getElementById("editDesc").value = team.description || "";

        // Reset slots
        teamSlots = [null, null, null, null, null];

        // Fill slots
        if (team.hero_ids && Array.isArray(team.hero_ids)) {
          team.hero_ids.forEach((hid, i) => {
            if (hid && heroesMap[hid]) {
              const h = heroesMap[hid];
              teamSlots[i] = {
                id: h.id,
                img: h.image_name,
                folder: h.skill_folder,
              };
            }
          });
        }

        // Fill skills
        skillPriority = team.skill_priority || [];

        // Fill Pet
        currentPet = team.pet_id || null;
        renderPetSlot();

        setFormation(currentFormation);
        new bootstrap.Modal(document.getElementById("teamEditorModal")).show();
      }

      // --- FORMATION LOGIC ---
      function setFormation(fmt) {
        currentFormation = fmt;
        document
          .querySelectorAll(".form-select-card")
          .forEach((el) => el.classList.remove("active"));
        const activeCard = document.getElementById(`form-card-${fmt}`);
        if (activeCard) activeCard.classList.add("active");
        renderSlots();
        updateFormationVisuals();
      }

      function updateFormationVisuals() {
        for (let i = 0; i < 5; i++) {
          const el = document.getElementById(`slot-${i}`);
          if (el) {
            el.className = `hero-input-slot ${
              teamSlots[i] ? "" : "empty"
            } slot-back`;
          }
        }

        let frontIndices = [];
        switch (currentFormation) {
          case "1-4":
            frontIndices = [2];
            break;
          case "2-3":
            frontIndices = [1, 3];
            break;
          case "3-2":
            frontIndices = [0, 2, 4];
            break;
          case "4-1":
            frontIndices = [0, 1, 3, 4];
            break;
        }

        frontIndices.forEach((idx) => {
          const el = document.getElementById(`slot-${idx}`);
          if (el) {
            el.classList.remove("slot-back");
            el.classList.add("slot-front");
          }
        });
      }

      function renderSlots() {
        teamSlots.forEach((h, i) => {
          const el = document.getElementById(`slot-${i}`);
          if (h) {
            el.innerHTML = `<img src="/images/heroes/${h.img}">`;
            el.classList.remove("empty");
          } else {
            el.innerHTML = `<i class="bi bi-plus-lg"></i>`;
            el.classList.add("empty");
          }
        });
        renderSkillMatrix();
        renderPetSlot(); // Ensure pet is rendered
      }

      function renderPetSlot() {
        const el = document.getElementById("slot-pet");
        if (currentPet) {
          el.classList.remove("empty");
          el.innerHTML = `<img src="/images/pets/${currentPet}">`;
        } else {
          el.classList.add("empty");
          el.innerHTML = `<i class="bi bi-github text-warning"></i>`;
        }
      }

      // --- PET PICKER LOGIC ---
      function openPetPicker() {
        const modal = new bootstrap.Modal(
          document.getElementById("petPickerModal")
        );
        modal.show();
      }

      function filterPets() {
        const term = document.getElementById("petSearch").value.toLowerCase();
        document.querySelectorAll("#petPickerModal .pet-item").forEach((el) => {
          el.style.display = el.dataset.name.includes(term) ? "block" : "none";
        });
      }

      function selectPet(filename) {
        currentPet = filename;
        renderPetSlot();
        const modalEl = document.getElementById("petPickerModal");
        const modal = bootstrap.Modal.getInstance(modalEl);
        modal.hide();
      }

      // --- HERO PICKER ---
      function openPicker(idx) {
        pickingSlotIndex = idx;
        document.getElementById("heroSearch").value = "";
        filterHeroes();
        new bootstrap.Modal(document.getElementById("heroPickerModal")).show();
      }

      function filterHeroes() {
        const term = document.getElementById("heroSearch").value.toLowerCase();
        document.querySelectorAll(".pick-item").forEach((el) => {
          el.style.display = el.dataset.name.includes(term) ? "block" : "none";
        });
      }

      function selectHero(filename) {
        const folder = filename.replace(/\.[^/.]+$/, "");
        teamSlots[pickingSlotIndex] = {
          id: filename,
          img: filename,
          folder: folder,
        };

        skillPriority = skillPriority.filter(
          (s) => !s.startsWith(`${pickingSlotIndex}_`)
        );

        const modalEl = document.getElementById("heroPickerModal");
        const modal = bootstrap.Modal.getInstance(modalEl);
        modal.hide();

        renderSlots();
        updateFormationVisuals();
      }

      function renderSkillMatrix() {
        const container = document.getElementById("skillMatrix");
        container.innerHTML = "";

        teamSlots.forEach((h, idx) => {
          if (!h) return;

          const col = document.createElement("div");
          col.className = "hero-col";

          // Check backend skills data if available, otherwise fallback
          // But wait, h.id is filename. heroesMap[h.id].skills should exist.
          let availableSkills = [];
          if (heroesMap[h.id] && heroesMap[h.id].skills) {
            availableSkills = heroesMap[h.id].skills;
          }

          // We want slots 2, 3 ONLY (files usually 2.png, 3.png)
          [2, 3].forEach((i) => {
            const filename = `${i}.png`;
            const val = `${idx}_${filename}`;

            // Check if this skill file actually exists for this hero
            // The user said: "If found 1,3,4 -> Leave 2 empty".
            // So we scan 1..5. If '2.png' is NOT in availableSkills, render empty box.

            const exists = availableSkills.includes(filename);

            const box = document.createElement("div");
            box.className = "skill-box" + (exists ? "" : " empty-skill");

            if (exists) {
              const pIdx = skillPriority.indexOf(val);
              if (pIdx > -1) {
                box.classList.add("selected");
                box.innerHTML = `<div class="order-badge">${pIdx + 1}</div>`;
              }

              const sImg = document.createElement("img");
              const folder = h.folder || h.img.replace(/\.[^/.]+$/, "");
              sImg.src = `/images/skill/${folder}/${filename}`;
              box.appendChild(sImg);
              box.onclick = () => toggleSkill(val);
            } else {
              // Empty slot (Visual only, or maybe unclickable?)
              // User said "leave slot 2 empty".
              box.style.opacity = "0.3";
              box.style.cursor = "default";
              box.style.borderStyle = "dashed";
            }

            col.appendChild(box);
          });

          container.appendChild(col);
        });
      }

      function toggleSkill(val) {
        const idx = skillPriority.indexOf(val);
        if (idx > -1) skillPriority.splice(idx, 1);
        else skillPriority.push(val);
        renderSkillMatrix();
      }

      // --- SAVE ---
      function saveTeamData() {
        const finalHeroIds = teamSlots.map((s) => (s ? s.id : null));
        if (finalHeroIds.every((id) => id === null))
          return alert("Add at least one hero!");

        const payload = {
          id: currentTeamId,
          raid_id: activeRaidId,
          team_name: document.getElementById("editName").value,
          formation: currentFormation,
          hero_ids: finalHeroIds,
          pet_id: currentPet, // Save Pet
          skill_priority: skillPriority,
          description: document.getElementById("editDesc").value,
          youtube_link: document.getElementById("editYoutube").value,
        };

        const csrfToken = document
          .querySelector('meta[name="csrf-token"]')
          .getAttribute("content");
        fetch("/admin/api/raid/save_team", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "CSRF-Token": csrfToken,
          },
          body: JSON.stringify(payload),
        })
          .then((res) => res.json())
          .then((data) => {
            if (data.success) location.reload();
            else alert("Error: " + data.error);
          });
      }
    </script>
    <% } %> <%- include('../../partials/footer') %>
  </body>
</html>
