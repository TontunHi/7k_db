<!DOCTYPE html>
<html lang="en">

<head>
    <%- include('../../partials/head') %>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>

        <link rel="stylesheet" href="/css/pages/admin/tierlist_manager.css">
</head>

<body class="text-light">

    <nav class="navbar-modern">
        <div class="nav-brand-box">
            <img src="/images/about_website/logo_seven_knights_rebirth.png" alt="Logo" class="site-logo">
            <div>
                <span class="nav-title">Tier Manager</span>
                <span class="nav-badge">
                    <%= category %>
                </span>
            </div>
        </div>

        <div class="d-flex align-items-center gap-4">
            <div class="cat-switcher d-flex gap-1 bg-dark rounded p-1 border border-secondary">
                <a href="?category=PVE" class="<%= category === 'PVE' ? 'active' : '' %>">PVE</a>
                <a href="?category=PVP" class="<%= category === 'PVP' ? 'active' : '' %>">PVP</a>
                <a href="?category=PET" class="<%= category === 'PET' ? 'active' : '' %>">PET</a>
            </div>

            <div class="d-flex gap-2">
                <a href="/admin/dashboard" class="nav-btn primary">
                    <i class="bi bi-grid-fill"></i> Panel
                </a>
                <a href="/admin/logout" class="nav-btn">
                    <i class="bi bi-box-arrow-right"></i> Logout
                </a>
            </div>
        </div>
    </nav>

    <div class="container admin-container">

        <div id="tier-rows-wrapper">
            <% ranks.forEach(rank=> { %>
                <div class="tier-row">
                    <div class="tier-rank-col">
                        <img src="/images/logo_tiers/<%= rank %>.png" alt="<%= rank %>" class="tier-rank-logo">
                    </div>
                    <div class="tier-content sortable-list" id="tier-<%= rank %>" data-rank="<%= rank %>">
                        <% tierData[rank].forEach(char=> { %>
                            <div class="char-card" data-filename="<%= char.filename %>">
                                <img src="/images/<%= folder %>/<%= char.filename %>">
                            </div>
                            <% }) %>
                    </div>
                </div>
                <% }) %>
        </div>

        <div class="pool-wrapper">
            <div class="pool-header">
                <div class="d-flex align-items-center gap-2">
                    <i class="bi bi-inbox-fill text-secondary fs-4"></i>
                    <div>
                        <h5 class="m-0 text-white">Character Pool</h5>
                        <small class="text-secondary">Drag characters from here to assign tiers</small>
                    </div>
                </div>
                <span class="badge bg-dark border border-secondary text-secondary">Unassigned</span>
            </div>

            <div class="pool-section sortable-list d-flex flex-wrap gap-2" id="pool-area" data-rank="POOL">
                <% poolData.forEach(char=> { %>
                    <div class="char-card" data-filename="<%= char.filename %>">
                        <img src="/images/<%= folder %>/<%= char.filename %>">
                    </div>
                    <% }) %>
            </div>
        </div>

    </div>

    <div id="save-indicator"><i class="bi bi-check-circle-fill me-2"></i>All changes saved</div>

    <%- include('../../partials/footer') %>

        <script>
            const sortableLists = document.querySelectorAll('.sortable-list');

            sortableLists.forEach(list => {
                new Sortable(list, {
                    group: 'shared',
                    animation: 250, // เพิ่ม Animation Time ให้นุ่มนวลขึ้น
                    delay: 0, // ไม่ต้องรอ กดปุ๊บลากปั๊บ
                    delayOnTouchOnly: true, // เฉพาะมือถือให้รอนิดนึง

                    // --- Key Settings for Smoothness & Scrolling ---
                    forceFallback: true, // ใช้ JS Drag แทน Native (จำเป็นสำหรับ Scroll Wheel)
                    fallbackClass: 'sortable-fallback', // Style ตอนลาก
                    fallbackOnBody: true, // ลากทะลุ Container ได้
                    fallbackTolerance: 3, // ขยับเมาส์เกิน 3px ถึงจะเริ่มลาก (ป้องกันการคลิกพลาด)

                    // --- Scroll Config ---
                    scroll: true,
                    scrollSensitivity: 150,
                    scrollSpeed: 20,
                    bubbleScroll: true,

                    // --- Visuals ---
                    ghostClass: 'sortable-ghost',

                    onEnd: function (evt) {
                        autoSave();
                    }
                });
            });

            // Debounce Save
            let saveTimeout;
            function autoSave() {
                clearTimeout(saveTimeout);

                const indicator = document.getElementById('save-indicator');
                indicator.style.display = 'block';
                indicator.style.backgroundColor = '#0dcaf0';
                indicator.innerHTML = '<i class="bi bi-arrow-repeat spin me-2"></i>Saving...';

                saveTimeout = setTimeout(() => {
                    const payload = [];
                    // [UPDATED] ใช้ Rank ชุดใหม่ EX -> E
                    const ranks = ['EX', 'S', 'A', 'B', 'C', 'D', 'E'];

                    ranks.forEach(rank => {
                        const container = document.getElementById('tier-' + rank);
                        if (container) {
                            const cards = container.querySelectorAll('.char-card');
                            cards.forEach(card => {
                                payload.push({
                                    filename: card.getAttribute('data-filename'),
                                    rank: rank
                                });
                            });
                        }
                    });

                    const csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute('content');

                    fetch('/admin/api/save_tier', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'CSRF-Token': csrfToken
                        },
                        body: JSON.stringify({
                            category: '<%= category %>',
                            data: payload
                        })
                    })
                        .then(res => res.json())
                        .then(data => {
                            if (data.success) {
                                indicator.style.backgroundColor = '#198754';
                                indicator.innerHTML = '<i class="bi bi-check-circle-fill me-2"></i>Saved';
                                setTimeout(() => { indicator.style.display = 'none'; }, 2000);
                            }
                        })
                        .catch(err => {
                            console.error(err);
                            indicator.style.backgroundColor = '#dc3545';
                            indicator.innerHTML = '<i class="bi bi-exclamation-triangle-fill me-2"></i>Error';
                        });
                }, 800);
            }
        </script>
</body>

</html>