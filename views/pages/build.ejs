<!DOCTYPE html>
<html lang="en">

<head>
    <%- include('../partials/head') %>
        <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>

        <link rel="stylesheet" href="/css/pages/build.css">
</head>

<body class="d-flex flex-column h-100 bg-main text-light">

    <%- include('../partials/navbar') %>

        <main class="flex-shrink-0 mt-5 pt-4">
            <div class="container py-5">
                <div class="d-flex align-items-center justify-content-between border-bottom border-secondary pb-3 mb-4">
                    <div>
                        <h1 class="display-5 fw-bold text-gradient text-uppercase">
                            <%= grade %> Heroes
                        </h1>
                        <p class="text-secondary mb-0">Select a hero to view recommended builds</p>
                    </div>

                    <div class="search-wrapper">
                        <i class="bi bi-search"></i>
                        <input type="text" id="heroSearch" placeholder="Search Hero...">
                    </div>
                </div>

                <div class="hero-grid" id="heroGrid">
                    <% heroes.forEach(hero=> { %>
                        <% const heroBuilds=buildsMap[hero.filename] || []; %>
                            <div class="hero-card"
                                onclick="openBuildModal('<%= hero.name %>', '<%= hero.filename %>', this)"
                                data-name="<%= hero.name.toLowerCase() %>"
                                data-builds='<%- JSON.stringify(heroBuilds).replace(/' /g, "&#39;" ) %>'
                                data-folder="<%= hero.skillFolder %>"
                                    data-allskills='<%= JSON.stringify(hero.allSkills || []) %>'
                                        data-priority='<%= JSON.stringify(hero.skillOrder || []) %>'>

                                            <img src="/images/heroes/<%= hero.filename %>" alt="<%= hero.name %>"
                                                loading="lazy">

                                            <% if (heroBuilds.length> 0) { %>
                                                <span class="build-count"><i class="bi bi-hammer me-1"></i>
                                                    <%= heroBuilds.length %>
                                                </span>
                                                <% } %>
                            </div>
                            <% }) %>
                </div>
            </div>
        </main>

        <div class="modal fade" id="buildModal" tabindex="-1" aria-hidden="true">
            <div class="modal-dialog modal-dialog-centered modal-lg modal-dialog-scrollable">
                <div class="modal-content">
                    <div class="modal-header">
                        <div class="d-flex align-items-center gap-3">
                            <img id="modalHeroImg" src=""
                                style="width: 50px; aspect-ratio: 3/4; object-fit: cover; border-radius: 4px; border: 1px solid #ffc107;">
                            <h4 class="modal-title text-warning text-capitalize me-2" id="modalHeroName">Hero Name</h4>
                            <!-- Skill Priority Container (Moved to Header) -->
                            <div id="modalSkillContainer" class="skill-list" style="display: none;"></div>
                        </div>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"
                            aria-label="Close"></button>
                    </div>
                    <div class="modal-body p-4" id="modalBody">
                        <div id="buildsContainer"></div>
                    </div>
                </div>
            </div>
        </div>

        <div id="captureArea">
        </div>

        <%- include('../partials/footer') %>

            <script>
                // --- 1. Search Logic ---
                const searchInput = document.getElementById('heroSearch');
                const heroGrid = document.getElementById('heroGrid');
                const cards = heroGrid.querySelectorAll('.hero-card');

                searchInput.addEventListener('input', (e) => {
                    const term = e.target.value.toLowerCase();
                    cards.forEach(card => {
                        const name = card.dataset.name;
                        card.style.display = name.includes(term) ? 'block' : 'none';
                    });
                });

                // --- 2. Modal Logic ---
                const buildModal = new bootstrap.Modal(document.getElementById('buildModal'));
                const modalBody = document.getElementById('modalBody'); // Not used directly for content anymore
                const buildsContainer = document.getElementById('buildsContainer');
                const modalSkillContainer = document.getElementById('modalSkillContainer');
                const modalHeroName = document.getElementById('modalHeroName');
                const modalHeroImg = document.getElementById('modalHeroImg');

                // Store current hero data for screenshot
                let currentHeroData = { name: '', filename: '' };

                function openBuildModal(heroName, heroFilename, cardElement) {
                    // Setup Header
                    modalHeroName.innerText = heroName;
                    modalHeroImg.src = `/images/heroes/${heroFilename}`;

                    // Store for Screenshot
                    currentHeroData.name = heroName;
                    currentHeroData.filename = heroFilename;

                    // Get Data
                    const buildsData = JSON.parse(cardElement.getAttribute('data-builds') || '[]');
                    const folder = cardElement.getAttribute('data-folder');
                    const allSkills = JSON.parse(cardElement.getAttribute('data-allskills') || '[]');
                    const priority = JSON.parse(cardElement.getAttribute('data-priority') || '[]');

                    // --- Render Skills ---
                    modalSkillContainer.innerHTML = '';
                    if (allSkills && allSkills.length > 0) {
                        modalSkillContainer.style.display = 'flex';

                        // Sort Skills Descending (3.png -> 1.png) same as Codex
                        allSkills.sort((a, b) => {
                            const numA = parseInt(a) || 0;
                            const numB = parseInt(b) || 0;
                            return numB - numA;
                        });

                        allSkills.forEach((filename) => {
                            const div = document.createElement('div');
                            div.className = 'skill-item';
                            div.title = filename;

                            // Check Priority
                            let badgeHtml = '';
                            const pIdx = priority.indexOf(filename);
                            if (pIdx > -1) {
                                badgeHtml = `<div class="priority-badge">${pIdx + 1}</div>`;
                            }

                            div.innerHTML = `
                        <img src="/images/skill/${folder}/${filename}" onerror="this.src='https://via.placeholder.com/60?text=Skill'">
                        ${badgeHtml}
                    `;
                            modalSkillContainer.appendChild(div);
                        });
                    } else {
                        modalSkillContainer.style.display = 'none';
                    }

                    // --- Render Builds ---
                    buildsContainer.innerHTML = '';

                    if (buildsData.length === 0) {
                        buildsContainer.innerHTML = `
                    <div class="text-center py-5 text-muted opacity-50">
                        <i class="bi bi-hammer display-1 mb-3"></i>
                        <h5>No builds available yet.</h5>
                    </div>
                `;
                    } else {
                        buildsData.forEach((build, index) => {
                            buildsContainer.innerHTML += createBuildHTML(build, index);
                        });
                    }

                    buildModal.show();
                }

                function createBuildHTML(build, index) {
                    const accHTML = build.accessories.map(acc =>
                        `<img src="/images/items/accessories/${acc}" title="${acc}">`
                    ).join('');

                    const subHTML = build.substats.map((stat, index) =>
                        `<span class="substat-chip">${index + 1}. ${stat}</span>`
                    ).join('');

                    // ใช้ ID เพื่ออ้างอิงตอน Screenshot
                    const buildId = `build-content-${index}`;

                    return `
                <div class="build-detail-card">
                    <button class="btn-screenshot" onclick="takeScreenshot(${index})" title="Save Build as Image">
                        <i class="bi bi-camera"></i>
                    </button>

                    <div id="${buildId}">
                        <div class="build-header">
                            <div>
                                <h5 class="fw-bold text-white mb-1">${build.build_name || 'Unnamed Build'}</h5>
                                <small class="text-secondary">${build.description || ''}</small>
                            </div>
                            <div class="build-badges text-end">
                                <span class="badge bg-warning text-dark">${build.c_level}</span>
                                <span class="badge bg-dark border border-secondary">${build.mode}</span>
                            </div>
                        </div>

                        <div class="build-items-grid">
                            <div class="item-box">
                                <img src="/images/items/weapon/${build.weapon1_img}" class="item-img" onerror="this.style.display='none'">
                                <div><p class="stat-text text-warning">Weapon</p><p class="stat-value">${build.weapon1_stat}</p></div>
                            </div>
                            <div class="item-box">
                                <img src="/images/items/armor/${build.armor1_img}" class="item-img" onerror="this.style.display='none'">
                                <div><p class="stat-text text-info">Armor</p><p class="stat-value">${build.armor1_stat}</p></div>
                            </div>
                            <div class="item-box">
                                <img src="/images/items/weapon/${build.weapon2_img}" class="item-img" onerror="this.style.display='none'">
                                <div><p class="stat-text text-warning">Weapon</p><p class="stat-value">${build.weapon2_stat}</p></div>
                            </div>
                            <div class="item-box">
                                <img src="/images/items/armor/${build.armor2_img}" class="item-img" onerror="this.style.display='none'">
                                <div><p class="stat-text text-info">Armor</p><p class="stat-value">${build.armor2_stat}</p></div>
                            </div>
                        </div>

                        <div class="row g-4 border-top border-secondary pt-3 mt-1">
                            <div class="col-md-6">
                                <small class="text-secondary fw-bold d-block mb-1 text-uppercase" style="font-size:0.75rem;">Accessories</small>
                                <div class="acc-list d-flex flex-wrap gap-2">
                                    ${accHTML}
                                </div>
                            </div>
                            <div class="col-md-6">
                                <small class="text-secondary fw-bold d-block mb-2 text-uppercase" style="font-size:0.75rem;">Substats Priority</small>
                                <div>
                                    ${subHTML}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
                }

                // --- 3. Screenshot Logic ---
                function takeScreenshot(index) {
                    const captureArea = document.getElementById('captureArea');
                    const buildContent = document.getElementById(`build-content-${index}`).innerHTML;

                    // Construct the visual for the screenshot
                    captureArea.innerHTML = `
                <div class="hero-header">
                    <img src="/images/heroes/${currentHeroData.filename}" class="hero-img">
                    <div>
                        <h2 class="text-capitalize text-warning">${currentHeroData.name}</h2>
                        <span class="text-secondary text-uppercase small">Build Configuration</span>
                    </div>
                </div>
                <div class="p-2 border border-secondary rounded bg-dark">
                    ${buildContent}
                </div>
                <div class="watermark">
                    7K Rebirth Database
                </div>
            `;

                    // Use html2canvas
                    html2canvas(captureArea, {
                        backgroundColor: '#121212', // Ensure dark background
                        scale: 2 // High resolution
                    }).then(canvas => {
                        // Trigger Download
                        const link = document.createElement('a');
                        link.download = `7K-Build-${currentHeroData.name}-${index + 1}.png`;
                        link.href = canvas.toDataURL();
                        link.click();
                    });
                }
            </script>
</body>

</html>