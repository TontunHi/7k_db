<%- include('../partials/head') %>
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <link rel="stylesheet" href="/css/pages/castle_rush.css">
    </head>

    <body>
        <%- include('../partials/navbar') %>

            <% if (viewState==='list' ) { %>
                <div class="container py-5">
                    <h2 class="text-white fw-bold mb-5 text-center text-uppercase" style="letter-spacing: 2px;">
                        <i class="bi bi-shield-shaded me-2 text-warning"></i>Castle Rush
                    </h2>
                    <div class="row g-4 justify-content-center">
                        <% stages.forEach(stage=> { %>
                            <div class="col-6 col-md-4 col-xl-3">
                                <a href="/castle-rush?stage_key=<%= stage.key %>" class="stage-card-link">
                                    <div class="stage-img-wrapper">
                                        <img src="/images/castle_rush/<%= stage.img %>"
                                            onerror="this.src='https://via.placeholder.com/300x450?text=No+Image'">
                                    </div>
                                    <div class="stage-info">
                                        <div class="stage-title">
                                            <%= stage.name %>
                                        </div>
                                    </div>
                                </a>
                            </div>
                            <% }) %>
                    </div>
                </div>
                <% } else { %>
                    <div class="page-header">
                        <div class="container d-flex align-items-center gap-3">
                            <a href="/castle-rush"
                                class="btn btn-outline-warning rounded-circle d-flex align-items-center justify-content-center"
                                style="width:40px;height:40px;"><i class="bi bi-arrow-left"></i></a>
                            <h2 class="m-0 fw-bold text-white text-uppercase">
                                <%= activeStage.name %>
                            </h2>
                        </div>
                    </div>

                    <div class="container pb-5">
                        <div class="row g-4 justify-content-center">
                            <% if(teams.length===0) { %>
                                <div class="col-12 text-center py-5 text-muted">
                                    <h5>No teams guide available for this day.</h5>
                                </div>
                                <% } %>

                                    <% teams.forEach(team=> { %>
                                        <div class="col-md-6 col-xl-4">
                                            <div class="team-comp-card" id="card-<%= team.id %>">
                                                <div class="comp-header">
                                                    <div>
                                                        <div class="comp-title">
                                                            <%= team.team_name || 'Team Guide' %>
                                                        </div>
                                                        <div class="comp-meta">Formation: <span>
                                                                <%= team.formation %>
                                                            </span></div>
                                                    </div>
                                                    <% if(team.youtube_link) { %>
                                                        <a href="<%= team.youtube_link %>" target="_blank"
                                                            class="text-danger fs-3"><i class="bi bi-youtube"></i></a>
                                                        <% } %>
                                                </div>

                                                <div class="comp-body">
                                                    <div class="hero-row">
                                                        <% let slotClasses=['slot-back', 'slot-back' , 'slot-back'
                                                            , 'slot-back' , 'slot-back' ]; if(team.formation==='1-4' )
                                                            slotClasses[2]='slot-front' ; else if(team.formation==='2-3'
                                                            ) { slotClasses[1]='slot-front' ;
                                                            slotClasses[3]='slot-front' ; } else
                                                            if(team.formation==='3-2' ) { slotClasses[0]='slot-front' ;
                                                            slotClasses[2]='slot-front' ; slotClasses[4]='slot-front' ;
                                                            } else if(team.formation==='4-1' ) {
                                                            slotClasses[0]='slot-front' ; slotClasses[1]='slot-front' ;
                                                            slotClasses[3]='slot-front' ; slotClasses[4]='slot-front' ;
                                                            } %>
                                                            <% team.hero_ids.forEach((hid, idx)=> { %>
                                                                <% let h=heroesMap[hid]; %>
                                                                    <div class="hero-column">
                                                                        <div
                                                                            class="hero-slot-visual <%= slotClasses[idx] %>">
                                                                            <% if(h) { %> <img
                                                                                    src="/images/heroes/<%= h.image_name %>">
                                                                                <% } %>
                                                                        </div>
                                                                        <div class="skill-stack">
                                                                            <% [2, 3].forEach(sIdx=> { %>
                                                                                <% let fileName=`${sIdx}.png`; let
                                                                                    orderKey=`${idx}_${fileName}`; let
                                                                                    orderIndex=-1;
                                                                                    if(team.skill_priority &&
                                                                                    team.skill_priority.includes(orderKey))
                                                                                    {
                                                                                    orderIndex=team.skill_priority.indexOf(orderKey)
                                                                                    + 1; } let exists=(h && h.skills &&
                                                                                    h.skills.includes(fileName)); %>
                                                                                    <% if(h && exists) { %>
                                                                                        <% let folder=h.skill_folder ||
                                                                                            h.image_name.replace(/\.[^/.]+$/, ""
                                                                                            ); %>
                                                                                            <div
                                                                                                class="skill-node <%= orderIndex > 0 ? 'has-order' : '' %>">
                                                                                                <img src="/images/skill/<%= folder %>/<%= fileName %>"
                                                                                                    onerror="this.style.opacity='0.1'">
                                                                                                <% if(orderIndex> 0) {
                                                                                                    %> <div
                                                                                                        class="skill-badge">
                                                                                                        <%= orderIndex
                                                                                                            %>
                                                                                                    </div>
                                                                                                    <% } %>
                                                                                            </div>
                                                                                            <% } else { %>
                                                                                                <div
                                                                                                    class="skill-node empty-slot">
                                                                                                </div>
                                                                                                <% } %>
                                                                                                    <% }) %>
                                                                        </div>
                                                                    </div>
                                                                    <% }) %>

                                                                        <% if(team.pet_id) { %>
                                                                            <div class="hero-column">
                                                                                <div class="hero-slot-visual slot-pet">
                                                                                    <img
                                                                                        src="/images/pets/<%= team.pet_id %>">
                                                                                </div>
                                                                            </div>
                                                                            <% } %>
                                                    </div>
                                                </div>

                                                <% if(team.description) { %>
                                                    <div class="desc-box">
                                                        <%= team.description %>
                                                    </div>
                                                    <% } %>

                                                        <div class="card-actions">
                                                            <button class="btn-capture-circle"
                                                                onclick="smartCapture('<%= team.id %>', '<%= activeStage.name %>', '<%= team.team_name %>')">
                                                                <i class="bi bi-camera-fill"></i>
                                                            </button>
                                                        </div>
                                            </div>
                                        </div>
                                        <% }) %>
                        </div>
                    </div>

                    <div id="capture-staging-area" style="position:fixed; top:-9999px; left:-9999px;"></div>

                    <script>
                        function smartCapture(teamId, stageName, teamName) {
                            const sourceCard = document.getElementById(`card-${teamId}`);
                            const staging = document.getElementById('capture-staging-area');
                            const btn = sourceCard.querySelector('.btn-capture-circle');
                            const originalIcon = btn.innerHTML;
                            btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span>';

                            const captureWrapper = document.createElement('div');
                            captureWrapper.className = 'capture-template-layout';

                            // Left Col (Stage Image)
                            const leftCol = document.createElement('div');
                            leftCol.className = 'capture-sidebar-col';
                            leftCol.innerHTML = `
                    <img src="/images/castle_rush/<%= activeStage.img %>">
                    <div class="capture-sidebar-title">${stageName.split(' ')[0]}</div>
                `;

                            // Right Col (Content)
                            const rightCol = document.createElement('div');
                            rightCol.className = 'capture-content-col';

                            // Header
                            const headerOriginal = sourceCard.querySelector('.comp-header');
                            const headerClone = headerOriginal.cloneNode(true);
                            const yt = headerClone.querySelector('a'); if (yt) yt.remove();
                            rightCol.appendChild(headerClone);

                            // Body (Hero + Skills)
                            const bodyOriginal = sourceCard.querySelector('.comp-body');
                            const bodyClone = bodyOriginal.cloneNode(true);
                            rightCol.appendChild(bodyClone);

                            // Description
                            const descOriginal = sourceCard.querySelector('.desc-box');
                            if (descOriginal) {
                                rightCol.appendChild(descOriginal.cloneNode(true));
                            }

                            // Watermark
                            const watermark = document.createElement('div');
                            watermark.style.marginTop = 'auto'; watermark.style.color = '#444'; watermark.style.fontSize = '0.8rem'; watermark.innerText = '7K Rebirth Guide';
                            rightCol.appendChild(watermark);

                            captureWrapper.appendChild(leftCol);
                            captureWrapper.appendChild(rightCol);
                            staging.innerHTML = '';
                            staging.appendChild(captureWrapper);

                            setTimeout(() => {
                                html2canvas(captureWrapper, {
                                    backgroundColor: '#15191d', scale: 2, logging: false
                                }).then(canvas => {
                                    const link = document.createElement('a');
                                    link.download = `CR_${stageName.split(' ')[0]}_${teamName}.png`;
                                    link.href = canvas.toDataURL('image/png');
                                    link.click();
                                    staging.innerHTML = '';
                                    btn.innerHTML = originalIcon;
                                }).catch(err => {
                                    console.error(err);
                                    alert('Error capturing');
                                    btn.innerHTML = originalIcon;
                                });
                            }, 100);
                        }
                    </script>
                    <% } %>

                        <%- include('../partials/footer') %>
    </body>

    </html>