<!DOCTYPE html>
<html lang="en">

<head>
    <%- include('../partials/head') %>
        <link rel="stylesheet" href="/css/pages/codex.css">
</head>

<body>

    <%- include('../partials/navbar') %>

        <div class="codex-layout">

            <aside class="sidebar-panel">
                <div class="sidebar-header">
                    <div class="sidebar-title">
                        <i class="bi bi-collection-fill text-warning"></i> Groups
                    </div>
                </div>
                <div class="group-list">
                    <% if(groups && groups.length> 0) { %>
                        <% groups.forEach(grp=> { %>
                            <a href="/codex/hero?cat_id=<%= activeCatId %>&group_id=<%= grp.id %>"
                                class="group-item <%= activeGroupId == grp.id ? 'active' : '' %>">
                                <span>
                                    <%= grp.name %>
                                </span>
                                <% if(activeGroupId==grp.id) { %> <i class="bi bi-chevron-right small"></i>
                                    <% } %>
                            </a>
                            <% }) %>
                                <% } else { %>
                                    <div class="text-center p-4 text-muted small">No Groups</div>
                                    <% } %>
                </div>
            </aside>

            <main class="content-panel">

                <div class="top-tabs-bar">
                    <span class="text-white small fw-bold me-2 text-uppercase opacity-50"
                        style="letter-spacing: 1px;">Categories:</span>
                    <% if(categories && categories.length> 0) { %>
                        <% categories.forEach(cat=> { %>
                            <a href="/codex/hero?cat_id=<%= cat.id %>"
                                class="cat-tab <%= activeCatId == cat.id ? 'active' : '' %>">
                                <%= cat.name %>
                            </a>
                            <% }) %>
                                <% } %>
                </div>

                <div class="hero-grid-container">
                    <% const currentGroup=groups.find(g=> g.id == activeGroupId); %>

                        <div class="mb-4">
                            <h1 class="section-title">
                                <%= currentGroup ? currentGroup.name : 'Select a Group' %>
                            </h1>
                            <p class="section-subtitle">
                                <%= currentGroup ? `Explore heroes from the ${currentGroup.name} group.`
                                    : 'Please select a group from the sidebar to view heroes.' %>
                            </p>
                        </div>

                        <div class="row g-4">
                            <% if(heroes.length===0) { %>
                                <div class="col-12">
                                    <div class="text-center py-5 text-muted"
                                        style="border: 2px dashed #222; border-radius: 12px;">
                                        <i class="bi bi-person-slash display-4 mb-3 opacity-25"></i>
                                        <h5>No heroes found in this group</h5>
                                        <p class="small opacity-50">Try selecting a different category or group.</p>
                                    </div>
                                </div>
                                <% } %>

                                    <% heroes.forEach(hero=> { %>
                                        <div class="col-6 col-sm-4 col-md-3 col-xl-2">
                                            <div class="hero-card" onclick="openHeroModal(this)"
                                                data-name="<%= hero.name %>" data-img="<%= hero.image_name %>"
                                                data-folder="<%= hero.skillFolder %>"
                                                data-allskills='<%= JSON.stringify(hero.allSkills || []) %>'
                                                data-priority='<%= JSON.stringify(hero.skillOrder || []) %>'>

                                                <div class="hero-img-wrapper">
                                                    <img src="/images/heroes/<%= hero.image_name %>" class="hero-img"
                                                        loading="lazy" alt="<%= hero.name %>">
                                                </div>
                                                <div class="hero-info">
                                                    <h3 class="hero-name">
                                                        <%= hero.name %>
                                                    </h3>
                                                </div>
                                            </div>
                                        </div>
                                        <% }) %>
                        </div>
                </div>

            </main>
        </div>

        <div class="modal fade" id="heroDetailModal" tabindex="-1">
            <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title"><i class="bi bi-stars text-warning me-2"></i><span
                                id="modalHeroName">Hero Name</span></h5>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body text-center">
                        <div class="mb-4 d-inline-block p-1 border border-warning rounded" style="background: #000;">
                            <img id="modalHeroImg" src=""
                                style="width: 120px; aspect-ratio: 3/4; object-fit: cover; border-radius: 4px;">
                        </div>

                        <h6 class="text-uppercase text-warning small fw-bold mb-3" style="letter-spacing: 1px;">Skill
                            Priority</h6>

                        <div id="modalSkillContainer" class="skill-list">
                        </div>

                        <div id="modalNoSkills" class="text-muted small mt-3 d-none">
                            No skill priority data available.
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <%- include('../partials/footer') %>

            <script>
                function openHeroModal(element) {
                    const name = element.getAttribute('data-name');
                    const img = element.getAttribute('data-img');
                    const folder = element.getAttribute('data-folder');
                    const allSkills = JSON.parse(element.getAttribute('data-allskills') || '[]');
                    const priority = JSON.parse(element.getAttribute('data-priority') || '[]');

                    // Sort Descending (3.png -> 1.png)
                    allSkills.sort((a, b) => {
                        const numA = parseInt(a) || 0;
                        const numB = parseInt(b) || 0;
                        return numB - numA;
                    });

                    document.getElementById('modalHeroName').innerText = name;
                    document.getElementById('modalHeroImg').src = `/images/heroes/${img}`;

                    const container = document.getElementById('modalSkillContainer');
                    const noSkillsMsg = document.getElementById('modalNoSkills');
                    container.innerHTML = '';

                    if (allSkills && allSkills.length > 0) {
                        noSkillsMsg.classList.add('d-none');
                        allSkills.forEach((filename) => {
                            const div = document.createElement('div');
                            div.className = 'skill-item';
                            div.title = filename;

                            // Check Priority
                            let badgeHtml = '';
                            const pIdx = priority.indexOf(filename);
                            if (pIdx > -1) {
                                badgeHtml = `<div class="priority-badge">${pIdx + 1}</div>`;
                            }

                            div.innerHTML = `
                                <img src="/images/skill/${folder}/${filename}" onerror="this.src='https://via.placeholder.com/80?text=Skill'">
                                ${badgeHtml}
                            `;
                            container.appendChild(div);
                        });
                    } else {
                        noSkillsMsg.classList.remove('d-none');
                    }
                    new bootstrap.Modal(document.getElementById('heroDetailModal')).show();
                }
            </script>
</body>

</html>