<!DOCTYPE html>
<html lang="en">

<head>
    <%- include('../partials/head') %>
        <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>

        <link rel="stylesheet" href="/css/pages/comp_dungeon.css">
</head>

<body class="d-flex flex-column h-100 bg-main text-light">

    <%- include('../partials/navbar') %>

        <main class="flex-shrink-0 mt-5 pt-4">
            <div class="container py-4" style="max-width: 900px;">

                <div class="page-title-box">
                    <h1 class="page-title">Dungeon Guide</h1>
                    <p class="text-secondary small">Optimal teams for daily dungeons</p>
                </div>

                <div id="dungeonContainer">
                    <% dungeons.forEach(dungeon=> { %>
                        <% let displayName=dungeon.banner .replace(/^\d+_/, '' ) .replace(/\.[^/.]+$/, '' )
                            .replace(/_/g, ' ' ); %>

                            <div class="dungeon-card">
                                <div class="dungeon-banner-box">
                                    <img src="/images/dungeon/<%= dungeon.banner %>" class="dungeon-banner-img">
                                </div>

                                <% dungeon.teams.forEach(team=> { %>
                                    <div class="team-row">
                                        <div class="team-clickable"
                                            onclick='viewTeamDetail(<%- JSON.stringify(team) %>, "<%= displayName %>")'
                                            title="Click to view details">
                                            <div class="formation-info">
                                                <img src="/images/formation/<%= team.formation %>.png">
                                                <span>
                                                    <%= team.formation %>
                                                </span>
                                            </div>

                                            <div class="heroes-container">
                                                <% let upIndices=[]; if(team.formation==='1-4' ) upIndices=[2]; else
                                                    if(team.formation==='2-3' ) upIndices=[1, 3]; else
                                                    if(team.formation==='3-2' ) upIndices=[0, 2, 4]; else
                                                    if(team.formation==='4-1' ) upIndices=[0, 1, 3, 4]; %>
                                                    <% team.heroes.forEach((h, i)=> { %>
                                                        <div
                                                            class="hero-slot <%= upIndices.includes(i) ? 'is-front' : '' %>">
                                                            <% if(h) { %> <img src="/images/heroes/<%= h %>">
                                                                <% } %>
                                                        </div>
                                                        <% }) %>
                                            </div>

                                            <% if(team.description) { %>
                                                <div class="desc-box">
                                                    <i class="bi bi-info-circle me-1"></i>
                                                    <%= team.description %>
                                                </div>
                                                <% } %>
                                        </div>

                                        <button class="btn-export"
                                            onclick='exportDungeonTeam(<%- JSON.stringify(team) %>, "<%= dungeon.banner %>", "<%= displayName %>")'
                                            title="Export Image">
                                            <i class="bi bi-camera"></i>
                                        </button>
                                    </div>
                                    <% }) %>
                            </div>
                            <% }) %>
                </div>
            </div>
        </main>

        <div class="modal fade" id="viewModal" tabindex="-1">
            <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="viewModalTitle">DUNGEON NAME</h5>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">

                        <div class="view-hero-container" id="viewHeroes"></div>

                        <div id="viewDescContainer" style="display: none;">
                            <div class="view-desc" id="viewDescText"></div>
                        </div>

                        <div class="text-center mt-4 pt-3 border-top border-secondary">
                            <div class="text-secondary small mb-2" style="font-size: 0.7rem; letter-spacing: 1px;">
                                FORMATION</div>
                            <div class="d-flex flex-column align-items-center">
                                <img id="viewFormationImg" src=""
                                    style="width: 50px; filter: drop-shadow(0 0 5px rgba(255,193,7,0.3));">
                                <span id="viewFormationText" class="text-warning fw-bold mt-1"
                                    style="font-size: 0.9rem;"></span>
                            </div>
                        </div>

                    </div>
                </div>
            </div>
        </div>

        <div id="captureArea">
            <div class="capture-banner">
                <img id="capBannerImg" src="" alt="Banner">
            </div>
            <div class="capture-body" id="capHeroes"></div>
            <div class="capture-desc" id="capDesc"></div>
            <div class="capture-footer">Generated by 7K Rebirth Database</div>
        </div>

        <%- include('../partials/footer') %>

            <script>
                const viewModal = new bootstrap.Modal(document.getElementById('viewModal'));

                function viewTeamDetail(teamData, displayName) {
                    // Set Title
                    document.getElementById('viewModalTitle').innerText = displayName;

                    // [UPDATED] Set Formation Image & Text
                    document.getElementById('viewFormationImg').src = `/images/formation/${teamData.formation}.png`;
                    document.getElementById('viewFormationText').innerText = teamData.formation;

                    // Set Description
                    const descContainer = document.getElementById('viewDescContainer');
                    const descText = document.getElementById('viewDescText');
                    if (teamData.description && teamData.description.trim() !== "") {
                        descContainer.style.display = 'block';
                        descText.innerText = teamData.description;
                    } else {
                        descContainer.style.display = 'none';
                    }

                    // Set Heroes
                    const container = document.getElementById('viewHeroes');
                    container.innerHTML = '';

                    let upIndices = [];
                    if (teamData.formation === '1-4') upIndices = [2];
                    else if (teamData.formation === '2-3') upIndices = [1, 3];
                    else if (teamData.formation === '3-2') upIndices = [0, 2, 4];
                    else if (teamData.formation === '4-1') upIndices = [0, 1, 3, 4];

                    teamData.heroes.forEach((h, i) => {
                        if (h) {
                            const isFront = upIndices.includes(i) ? 'v-front' : '';
                            const html = `
                        <div class="view-hero-slot ${isFront}">
                            <img src="/images/heroes/${h}">
                        </div>
                    `;
                            container.insertAdjacentHTML('beforeend', html);
                        }
                    });

                    viewModal.show();
                }

                function exportDungeonTeam(teamData, bannerFilename, displayName) {
                    const capture = document.getElementById('captureArea');
                    const capBannerImg = document.getElementById('capBannerImg');
                    const capHeroes = document.getElementById('capHeroes');
                    const capDesc = document.getElementById('capDesc');

                    // Set Banner
                    capBannerImg.src = `/images/dungeon/${bannerFilename}`;

                    // Set Desc
                    if (teamData.description && teamData.description.trim() !== "") {
                        capDesc.style.display = 'block';
                        capDesc.innerHTML = `<i class="bi bi-quote me-2 text-warning"></i>${teamData.description}`;
                    } else {
                        capDesc.style.display = 'none';
                    }

                    // Hero Logic
                    let upIndices = [];
                    if (teamData.formation === '1-4') upIndices = [2];
                    else if (teamData.formation === '2-3') upIndices = [1, 3];
                    else if (teamData.formation === '3-2') upIndices = [0, 2, 4];
                    else if (teamData.formation === '4-1') upIndices = [0, 1, 3, 4];

                    let html = '';

                    teamData.heroes.forEach((h, i) => {
                        if (h) {
                            const isFront = upIndices.includes(i) ? 'front' : '';
                            html += `
                        <div class="capture-hero ${isFront}">
                            <img src="/images/heroes/${h}" onload="checkImages()">
                        </div>
                    `;
                        }
                    });
                    capHeroes.innerHTML = html;

                    let loadedImages = 0;
                    window.checkImages = function () {
                        loadedImages++;
                    }

                    setTimeout(() => {
                        html2canvas(capture, {
                            backgroundColor: '#121212',
                            scale: 1,
                            useCORS: true,
                            allowTaint: true,
                            onclone: (clonedDoc) => {
                                const clonedBody = clonedDoc.getElementById('capHeroes');
                                clonedBody.style.display = 'flex';
                                const clonedDesc = clonedDoc.getElementById('capDesc');
                                if (teamData.description && teamData.description.trim() !== "") {
                                    clonedDesc.style.display = 'block';
                                }
                            }
                        }).then(canvas => {
                            const link = document.createElement('a');
                            link.download = `7K-Dungeon-${displayName.replace(/\s+/g, '_')}.png`;
                            link.href = canvas.toDataURL();
                            link.click();
                        });
                    }, 800);
                }
            </script>
</body>

</html>