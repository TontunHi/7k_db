<!DOCTYPE html>
<html lang="en">

<head>
    <%- include('../partials/head') %>
        <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
        <link rel="stylesheet" href="/css/pages/comp_stage.css">
</head>

<body class="d-flex flex-column h-100 bg-main text-light">

    <%- include('../partials/navbar') %>

        <main class="flex-shrink-0 mt-5 pt-4">
            <div class="container py-5">
                <div class="text-center mb-5">
                    <h1 class="display-4 fw-bold text-gradient">Stage & Nightmare</h1>
                    <p class="text-secondary">Recommended team compositions and strategies</p>
                </div>
                <div class="filter-container">
                    <button class="filter-btn active" data-filter="all" onclick="filterStages('all', this)">All</button>
                    <button class="filter-btn" data-filter="Stage" onclick="filterStages('Stage', this)">Stage</button>
                    <button class="filter-btn" data-filter="Nightmare"
                        onclick="filterStages('Nightmare', this)">Nightmare</button>
                </div>

                <div id="stagesContainer">
                    <% stages.forEach(group=> { %>
                        <div class="stage-card filter-item" data-type="<%= group.type %>">
                            <div class="stage-header header-<%= group.type.toLowerCase() %>">
                                <span class="stage-number">
                                    <%= group.stage_main %> - <%= group.stage_sub %>
                                </span>
                                <span class="stage-badge badge-<%= group.type.toLowerCase() %>">
                                    <%= group.type %>
                                </span>
                            </div>

                            <% group.teams.forEach(team=> { %>
                                <% if(group.type==='Nightmare' ) { %>
                                    <div class="team-header-label" style="color: #ffc107;">
                                        TEAM <%= team.team_order %>
                                    </div>
                                    <% } %>

                                        <div class="team-row">
                                            <div class="formation-info">
                                                <img src="/images/formation/<%= team.formation %>.png">
                                                <span>
                                                    <%= team.formation %>
                                                </span>
                                            </div>
                                            <div class="heroes-container">
                                                <% let upIndices=[]; if(team.formation==='1-4' ) upIndices=[2]; else
                                                    if(team.formation==='2-3' ) upIndices=[1, 3]; else
                                                    if(team.formation==='3-2' ) upIndices=[0, 2, 4]; else
                                                    if(team.formation==='4-1' ) upIndices=[0, 1, 3, 4]; %>
                                                    <% team.heroes.forEach((h, i)=> { %>
                                                        <div
                                                            class="hero-slot <%= upIndices.includes(i) ? 'is-front' : '' %>">
                                                            <% if(h) { %> <img src="/images/heroes/<%= h %>">
                                                                <% } %>
                                                        </div>
                                                        <% }) %>
                                            </div>
                                            <% if(team.description) { %>
                                                <div class="desc-box"><i
                                                        class="bi bi-info-circle me-2 text-warning"></i>
                                                    <%= team.description %>
                                                </div>
                                                <% } %>
                                                    <button class="btn-export"
                                                        onclick='exportTeam(<%- JSON.stringify(team) %>, "<%= group.type %>")'
                                                        title="Export Image">
                                                        <i class="bi bi-camera"></i>
                                                    </button>
                                        </div>
                                        <% }) %>
                        </div>
                        <% }) %>
                            <% if(stages.length===0) { %>
                                <div class="text-center py-5 text-muted"><i class="bi bi-inbox display-1"></i>
                                    <p class="mt-3">No guides available yet.</p>
                                </div>
                                <% } %>
                </div>
            </div>
        </main>

        <div id="captureArea">
            <div class="capture-header" id="capHeader">
                <div>
                    <h1 style="margin:0; font-size: 2.5rem; font-weight:800; color:#fff;" id="capStage">Stage</h1>
                    <span id="capTypeBadge"
                        style="background:#fff; color:#000; padding:2px 10px; border-radius:4px; font-weight:bold; font-size:0.9rem;">TYPE</span>
                </div>
                <div style="text-align:right;">
                    <div style="font-size:1.2rem; color:#fff; font-weight:bold;">7K Rebirth</div>
                    <div style="font-size:0.8rem; color:#888;">Database Guide</div>
                </div>
            </div>
            <div class="capture-body" id="capHeroes"></div>
            <div class="capture-desc" id="capDesc" style="display: none;"></div>
            <div class="capture-footer">Generated by 7K Rebirth Database</div>
        </div>

        <%- include('../partials/footer') %>

            <script>
                function filterStages(type, btn) {
                    document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    const items = document.querySelectorAll('.filter-item');
                    items.forEach(item => {
                        if (type === 'all' || item.dataset.type === type) {
                            item.style.display = 'block';
                            item.style.opacity = '0';
                            item.style.transform = 'translateY(10px)';
                            setTimeout(() => { item.style.opacity = '1'; item.style.transform = 'translateY(0)'; }, 50);
                        } else { item.style.display = 'none'; }
                    });
                }

                function exportTeam(teamData, type) {
                    const capture = document.getElementById('captureArea');
                    const capHeader = document.getElementById('capHeader');
                    const capStage = document.getElementById('capStage');
                    const capBadge = document.getElementById('capTypeBadge');
                    const capHeroes = document.getElementById('capHeroes');
                    const capDesc = document.getElementById('capDesc');

                    capStage.innerText = `${teamData.stage_main} - ${teamData.stage_sub}`;
                    capBadge.innerText = type.toUpperCase();

                    if (teamData.description && teamData.description.trim() !== "") {
                        capDesc.style.display = 'block';
                        capDesc.innerHTML = `<i class="bi bi-quote me-2 text-warning"></i>${teamData.description}`;
                    } else { capDesc.style.display = 'none'; }

                    if (type === 'Stage') {
                        capHeader.style.background = '#f1e3b6'; capStage.style.color = '#3d3314';
                        capBadge.style.background = '#3d3314'; capBadge.style.color = '#f1e3b6';
                    } else {
                        capHeader.style.background = '#d2ade6'; capStage.style.color = '#2e1a3b';
                        capBadge.style.background = '#2e1a3b'; capBadge.style.color = '#d2ade6';
                    }

                    let upIndices = [];
                    if (teamData.formation === '1-4') upIndices = [2];
                    else if (teamData.formation === '2-3') upIndices = [1, 3];
                    else if (teamData.formation === '3-2') upIndices = [0, 2, 4];
                    else if (teamData.formation === '4-1') upIndices = [0, 1, 3, 4];

                    let html = '';
                    teamData.heroes.forEach((h, i) => {
                        if (h) {
                            const isFront = upIndices.includes(i) ? 'front' : '';
                            html += `<div class="capture-hero ${isFront}"><img src="/images/heroes/${h}" onload="checkImages()"></div>`;
                        }
                    });
                    capHeroes.innerHTML = html;

                    let loadedImages = 0;
                    window.checkImages = function () { loadedImages++; }

                    setTimeout(() => {
                        html2canvas(capture, {
                            backgroundColor: '#121212', scale: 2, useCORS: true, allowTaint: true,
                            onclone: (clonedDoc) => {
                                const clonedBody = clonedDoc.getElementById('capHeroes');
                                clonedBody.style.display = 'flex';
                                const clonedDesc = clonedDoc.getElementById('capDesc');
                                if (teamData.description && teamData.description.trim() !== "") {
                                    clonedDesc.style.display = 'block';
                                }
                            }
                        }).then(canvas => {
                            const link = document.createElement('a');
                            link.download = `7K-${type}-${teamData.stage_main}-${teamData.stage_sub}.png`;
                            link.href = canvas.toDataURL();
                            link.click();
                        });
                    }, 500);
                }
            </script>
</body>

</html>