<!DOCTYPE html>
<html lang="en">
<head>
    <%- include('../partials/head') %>
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <style>
        /* --- Theme --- */
        body { background-color: #0b0c10; color: #e0e0e0; font-family: 'Kanit', sans-serif; padding-top: 80px; }
        
        /* --- Raid List (Grid Style) --- */
        .raid-card-grid {
            display: block; text-decoration: none; color: inherit;
            background: #1f2833; border: 1px solid #45a29e; border-radius: 12px;
            overflow: hidden; transition: 0.3s; height: 100%; position: relative;
        }
        .raid-card-grid:hover { 
            transform: translateY(-5px); 
            box-shadow: 0 10px 20px rgba(255, 193, 7, 0.2); 
            border-color: #ffc107; 
        }
        .raid-img-wrapper {
            width: 100%; aspect-ratio: 2/3; overflow: hidden;
            border-bottom: 1px solid #333;
        }
        .raid-img-wrapper img { width: 100%; height: 100%; object-fit: cover; transition: 0.3s; }
        .raid-card-grid:hover .raid-img-wrapper img { transform: scale(1.05); }
        
        .raid-grid-info { padding: 15px; text-align: center; background: #15191d; }
        .raid-grid-title { 
            font-size: 1.1rem; font-weight: 700; color: #fff; margin: 0; 
            text-transform: uppercase; letter-spacing: 1px;
            white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
        }

        /* --- Team Detail View --- */
        .page-header { background: #1f2833; padding: 20px 0; border-bottom: 1px solid #45a29e; margin-bottom: 30px; }
        
        /* Card Layout */
        .team-comp-card {
            background: #15191d; border: 1px solid #2f3a46; border-radius: 12px; padding: 20px;
            margin-bottom: 30px; display: flex; flex-direction: column;
            box-shadow: 0 4px 10px rgba(0,0,0,0.3);
        }

        /* Header Info */
        .comp-title { color: #ffc107; font-weight: 700; font-size: 1.25rem; margin-bottom: 5px; }
        .comp-meta { color: #aaa; font-size: 0.9rem; display: flex; gap: 10px; align-items: center; }
        .comp-meta span { color: #fff; }

        /* Formation Field */
        .battle-field {
            background: #0b0c10; border-radius: 12px; border: 2px solid #2f3a46;
            padding: 40px 10px 20px 10px; /* เพิ่ม padding บนเพื่อให้พื้นที่ Slot ที่เด้งขึ้น */
            margin: 20px 0;
            display: flex; justify-content: center; align-items: center;
            min-height: 160px;
            background-image: radial-gradient(#1f2833 1px, transparent 1px); background-size: 15px 15px;
            overflow: visible; /* ห้ามซ่อนส่วนเกิน */
        }
        .hero-row { display: flex; gap: 8px; align-items: center; justify-content: center; }
        
        .hero-slot-visual {
            width: 60px; height: 85px; background: #000; border-radius: 6px;
            /* Border default (จะถูกทับด้วย class logic) */
            border: 2px solid #444; 
            overflow: hidden; position: relative;
            box-shadow: 0 4px 8px rgba(0,0,0,0.5); 
            transition: 0.2s;
        }
        .hero-slot-visual img { width: 100%; height: 100%; object-fit: cover; }
        
        /* --- [UPDATE] COLOR LOGIC FOR SCREENSHOT --- */
        
        /* ตัวที่เลื่อนขึ้น (BLUE/CYAN) */
        .slot-front { 
            border-color: #0dcaf0 !important; /* ฟ้าสดใส */
            transform: translateY(-25px); /* เลื่อนขึ้น */
            box-shadow: 0 10px 15px rgba(13, 202, 240, 0.3) !important;
            z-index: 10; /* อยู่ชั้นบนสุด ไม่โดนบัง */
        }

        /* ตัวที่อยู่กับที่ (RED) */
        .slot-back { 
            border-color: #dc3545 !important; /* แดง */
            z-index: 1; /* อยู่ชั้นล่าง */
            opacity: 0.9;
        }

        /* Skill Order (Vertical Grid) */
        .skill-section-title { font-size: 0.85rem; font-weight: 700; color: #888; text-transform: uppercase; margin-bottom: 10px; border-left: 3px solid #ffc107; padding-left: 10px; }
        
        .skill-container {
            display: grid;
            grid-template-rows: repeat(2, 1fr);
            grid-auto-flow: column;
            gap: 8px;
            overflow-x: auto;
            padding-bottom: 5px;
            justify-content: start;
        }
        
        .skill-node { 
            position: relative; width: 40px; height: 40px; 
            border-radius: 6px; border: 1px solid #444; 
            overflow: hidden; background: #000; flex-shrink: 0;
        }
        .skill-node img { width: 100%; height: 100%; object-fit: cover; }
        .skill-badge { 
            position: absolute; top: 0; right: 0; 
            background: #ffc107; color: #000; 
            font-size: 10px; font-weight: 800; 
            width: 16px; height: 16px; 
            display: flex; align-items: center; justify-content: center;
            border-bottom-left-radius: 4px;
        }

        /* Description Box */
        .desc-box { background: rgba(255,255,255,0.05); border-radius: 8px; padding: 10px; color: #ddd; font-size: 0.9rem; margin-top: 15px; border-left: 3px solid #ffc107; }

        /* Actions */
        .card-actions { display: flex; justify-content: flex-end; margin-top: 15px; padding-top: 15px; border-top: 1px solid #333; }
        .btn-capture-circle {
            width: 40px; height: 40px; border-radius: 50%;
            background: #2c2c2c; border: 1px solid #444; color: #aaa;
            display: flex; align-items: center; justify-content: center;
            transition: all 0.2s; font-size: 1.2rem; cursor: pointer;
        }
        .btn-capture-circle:hover { background: #444; color: #fff; border-color: #ffc107; color: #ffc107; }

        /* --- SCREENSHOT TEMPLATE (Off-Screen) --- */
        .capture-template-layout {
            display: flex; flex-direction: row; 
            background: #15191d; width: 900px;
            border: 2px solid #ffc107; border-radius: 0;
        }
        .capture-sidebar-col {
            width: 250px; background: #000; position: relative; overflow: hidden;
            display: flex; align-items: center; justify-content: center;
            border-right: 2px solid #ffc107;
        }
        .capture-sidebar-col img {
            width: 100%; height: 100%; object-fit: cover; opacity: 0.6;
        }
        .capture-sidebar-title {
            position: absolute; color: #fff; font-weight: 800; font-size: 2.2rem;
            text-transform: uppercase; text-shadow: 0 0 10px #ffc107;
            transform: rotate(-90deg); white-space: nowrap;
        }
        .capture-content-col {
            flex: 1; padding: 30px; display: flex; flex-direction: column;
        }
        
        /* Capture Specific Overrides */
        .capture-content-col .battle-field { 
            border-color: #444; background: #0e0e0e; min-height: 200px; 
            overflow: visible !important;
        }
        /* แก้ไข Bug สีดำบังรูป: ลบ Background และ Overflow ในโหมด Capture */
        .capture-content-col .hero-slot-visual { 
            width: 80px; height: 110px; 
            overflow: visible !important; 
            background: transparent !important; 
            box-shadow: none !important;
        }
        .capture-content-col .hero-slot-visual img {
            border-radius: 6px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.8); /* เงาที่รูปแทน */
        }
        .capture-content-col .slot-front {
            /* ยืนยันสีฟ้าใน screenshot */
            border-color: #0dcaf0 !important;
            transform: translateY(-30px);
            z-index: 100 !important;
        }
        .capture-content-col .slot-back {
            /* ยืนยันสีแดงใน screenshot */
            border-color: #dc3545 !important;
        }
        
        .capture-content-col .comp-title { font-size: 2rem; color: #ffc107; }
        .capture-content-col .skill-node { width: 50px; height: 50px; }
        .capture-content-col .skill-container { gap: 10px; }

    </style>
</head>
<body>
    
    <%- include('../partials/navbar') %>

    <% if (viewState === 'list') { %>
        <div class="container py-5">
            <h2 class="text-white fw-bold mb-5 text-center text-uppercase" style="letter-spacing: 2px;">
                <i class="bi bi-crosshair me-2 text-warning"></i>Raid Boss
            </h2>

            <div class="row g-4 justify-content-center">
                <% if(raids.length > 0) { %>
                    <% raids.forEach(r => { %>
                        <div class="col-6 col-md-4 col-xl-3">
                            <a href="/raid?raid_id=<%= r.id %>" class="raid-card-grid">
                                <div class="raid-img-wrapper">
                                    <img src="/images/raid/<%= r.image_name %>">
                                </div>
                                <div class="raid-grid-info">
                                    <div class="raid-grid-title"><%= r.displayName %></div>
                                </div>
                            </a>
                        </div>
                    <% }) %>
                <% } else { %>
                    <div class="col-12 text-center py-5 text-muted border border-secondary border-dashed rounded">
                        <h5>No Raids Available</h5>
                    </div>
                <% } %>
            </div>
        </div>

    <% } else { %>
        <div class="page-header">
            <div class="container d-flex align-items-center gap-3">
                <a href="/raid" class="btn btn-outline-warning rounded-circle d-flex align-items-center justify-content-center" style="width:40px;height:40px;"><i class="bi bi-arrow-left"></i></a>
                <h2 class="m-0 fw-bold text-white text-uppercase"><%= activeRaid.displayName %></h2>
            </div>
        </div>

        <div class="container pb-5">
            <div class="row g-4">
                <% if(teams.length === 0) { %>
                    <div class="col-12 text-center py-5 text-muted"><h5>No teams guide available.</h5></div>
                <% } %>

                <% teams.forEach((team, tIndex) => { %>
                    <div class="col-md-6 col-xl-4">
                        <div class="team-comp-card" id="card-<%= team.id %>">
                            
                            <div class="d-flex justify-content-between align-items-start mb-2">
                                <div>
                                    <div class="comp-title"><%= team.team_name || 'Team Guide' %></div>
                                    <div class="comp-meta">
                                        Formation: <span><%= team.formation %></span>
                                    </div>
                                </div>
                                <% if(team.youtube_link) { %>
                                    <a href="<%= team.youtube_link %>" target="_blank" class="text-danger fs-3"><i class="bi bi-youtube"></i></a>
                                <% } %>
                            </div>

                            <div class="battle-field">
                                <div class="hero-row">
                                    <% 
                                        let slotClasses = ['slot-back', 'slot-back', 'slot-back', 'slot-back', 'slot-back'];
                                        if(team.formation === '1-4') slotClasses[2] = 'slot-front';
                                        else if(team.formation === '2-3') { slotClasses[1] = 'slot-front'; slotClasses[3] = 'slot-front'; }
                                        else if(team.formation === '3-2') { slotClasses[0] = 'slot-front'; slotClasses[2] = 'slot-front'; slotClasses[4] = 'slot-front'; }
                                        else if(team.formation === '4-1') { slotClasses[0]='slot-front'; slotClasses[1]='slot-front'; slotClasses[3]='slot-front'; slotClasses[4]='slot-front'; }
                                    %>
                                    <% team.hero_ids.forEach((hid, idx) => { %>
                                        <% let h = heroesMap[hid]; %>
                                        <div class="hero-slot-visual <%= slotClasses[idx] %>">
                                            <% if(h) { %>
                                                <img src="/images/heroes/<%= h.image_name %>">
                                            <% } %>
                                        </div>
                                    <% }) %>
                                </div>
                            </div>

                            <div class="mb-3">
                                <div class="skill-section-title">Skill Order</div>
                                <div class="skill-container">
                                    <% if(team.skill_priority && team.skill_priority.length > 0) { %>
                                        <% team.skill_priority.forEach((val, idx) => { %>
                                            <% 
                                                const [hIdx, file] = val.split('_');
                                                const heroId = team.hero_ids[parseInt(hIdx)];
                                                const hero = heroesMap[heroId];
                                            %>
                                            <% if(hero) { %>
                                                <div class="skill-node">
                                                    <img src="/images/skill/<%= hero.skill_folder || hero.image_name.replace(/\.[^/.]+$/, "") %>/<%= file %>">
                                                    <div class="skill-badge"><%= idx + 1 %></div>
                                                </div>
                                            <% } %>
                                        <% }) %>
                                    <% } else { %>
                                        <small class="text-muted">No specific order</small>
                                    <% } %>
                                </div>
                            </div>

                            <% if(team.description) { %>
                                <div class="desc-box"><%= team.description %></div>
                            <% } %>

                            <div class="card-actions">
                                <button class="btn-capture-circle" onclick="smartCapture('<%= team.id %>', '<%= activeRaid.displayName %>', '<%= team.team_name %>')">
                                    <i class="bi bi-camera-fill"></i>
                                </button>
                            </div>

                        </div>
                    </div>
                <% }) %>
            </div>
        </div>

        <div id="capture-staging-area" style="position:fixed; top:-9999px; left:-9999px;"></div>

        <script>
            function smartCapture(teamId, raidName, teamName) {
                const sourceCard = document.getElementById(`card-${teamId}`);
                const staging = document.getElementById('capture-staging-area');
                const btn = sourceCard.querySelector('.btn-capture-circle');

                // 1. Loading
                const originalIcon = btn.innerHTML;
                btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span>';

                // 2. Clone for Screenshot
                const captureWrapper = document.createElement('div');
                captureWrapper.className = 'capture-template-layout';

                // Sidebar
                const leftCol = document.createElement('div');
                leftCol.className = 'capture-sidebar-col';
                leftCol.innerHTML = `
                    <img src="/images/raid/<%= activeRaid.image_name %>">
                    <div class="capture-sidebar-title">${raidName}</div>
                `;

                // Content
                const rightCol = document.createElement('div');
                rightCol.className = 'capture-content-col';
                
                const headerClone = sourceCard.querySelector('.d-flex.justify-content-between').cloneNode(true);
                const yt = headerClone.querySelector('a'); if(yt) yt.remove();
                
                const fieldClone = sourceCard.querySelector('.battle-field').cloneNode(true);
                const skillClone = sourceCard.querySelector('.mb-3').cloneNode(true);
                const descClone = sourceCard.querySelector('.desc-box') ? sourceCard.querySelector('.desc-box').cloneNode(true) : null;

                rightCol.appendChild(headerClone);
                rightCol.appendChild(fieldClone);
                rightCol.appendChild(skillClone);
                if(descClone) rightCol.appendChild(descClone);
                
                const watermark = document.createElement('div');
                watermark.style.marginTop = 'auto'; watermark.style.color='#444'; watermark.style.fontSize='0.8rem'; watermark.innerText = '7K Rebirth Guide';
                rightCol.appendChild(watermark);

                captureWrapper.appendChild(leftCol);
                captureWrapper.appendChild(rightCol);

                staging.innerHTML = '';
                staging.appendChild(captureWrapper);

                // 3. Capture
                setTimeout(() => {
                    html2canvas(captureWrapper, {
                        backgroundColor: '#15191d',
                        scale: 2,
                        logging: false
                    }).then(canvas => {
                        const link = document.createElement('a');
                        link.download = `Raid_${raidName}_${teamName}.png`;
                        link.href = canvas.toDataURL('image/png');
                        link.click();

                        staging.innerHTML = '';
                        btn.innerHTML = originalIcon;
                    }).catch(err => {
                        console.error(err);
                        alert('Error capturing');
                        btn.innerHTML = originalIcon;
                    });
                }, 100);
            }
        </script>
    <% } %>

    <%- include('../partials/footer') %>
</body>
</html>