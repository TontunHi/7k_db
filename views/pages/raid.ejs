<!DOCTYPE html>
<html lang="en">

<head>
    <%- include('../partials/head') %>
        <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
        <link rel="stylesheet" href="/css/pages/raid.css">
</head>

<body>

    <%- include('../partials/navbar') %>

        <% if (viewState==='list' ) { %>
            <div class="container py-5">
                <h2 class="text-white fw-bold mb-5 text-center text-uppercase" style="letter-spacing: 2px;">
                    <i class="bi bi-crosshair me-2 text-warning"></i>Raid Boss
                </h2>

                <div class="row g-4 justify-content-center">
                    <% if(raids.length> 0) { %>
                        <% raids.forEach(r=> { %>
                            <div class="col-6 col-md-4 col-xl-3">
                                <a href="/raid?raid_id=<%= r.id %>" class="raid-card-grid">
                                    <div class="raid-img-wrapper">
                                        <img src="/images/raid/<%= r.image_name %>">
                                    </div>
                                    <div class="raid-grid-info">
                                        <div class="raid-grid-title">
                                            <%= r.displayName %>
                                        </div>
                                    </div>
                                </a>
                            </div>
                            <% }) %>
                                <% } else { %>
                                    <div
                                        class="col-12 text-center py-5 text-muted border border-secondary border-dashed rounded">
                                        <h5>No Raids Available</h5>
                                    </div>
                                    <% } %>
                </div>
            </div>

            <% } else { %>
                <div class="page-header">
                    <div class="container d-flex align-items-center gap-3">
                        <a href="/raid"
                            class="btn btn-outline-warning rounded-circle d-flex align-items-center justify-content-center"
                            style="width:40px;height:40px;"><i class="bi bi-arrow-left"></i></a>
                        <h2 class="m-0 fw-bold text-white text-uppercase">
                            <%= activeRaid.displayName %>
                        </h2>
                    </div>
                </div>

                <div class="container pb-5">
                    <div class="row g-4">
                        <% if(teams.length===0) { %>
                            <div class="col-12 text-center py-5 text-muted">
                                <h5>No teams guide available.</h5>
                            </div>
                            <% } %>

                                <% teams.forEach((team, tIndex)=> { %>
                                    <div class="col-md-6 col-xl-4">
                                        <div class="team-comp-card" id="card-<%= team.id %>">
                                            <div class="d-flex justify-content-between align-items-start mb-2">
                                                <div>
                                                    <div class="comp-title">
                                                        <%= team.team_name || 'Team Guide' %>
                                                    </div>
                                                    <div class="comp-meta">
                                                        Formation: <span>
                                                            <%= team.formation %>
                                                        </span>
                                                    </div>
                                                </div>
                                                <% if(team.youtube_link) { %>
                                                    <a href="<%= team.youtube_link %>" target="_blank"
                                                        class="text-danger fs-3"><i class="bi bi-youtube"></i></a>
                                                    <% } %>
                                            </div>

                                            <div class="battle-field">
                                                <div class="hero-row">
                                                    <% let slotClasses=['slot-back', 'slot-back' , 'slot-back'
                                                        , 'slot-back' , 'slot-back' ]; if(team.formation==='1-4' )
                                                        slotClasses[2]='slot-front' ; else if(team.formation==='2-3' ) {
                                                        slotClasses[1]='slot-front' ; slotClasses[3]='slot-front' ; }
                                                        else if(team.formation==='3-2' ) { slotClasses[0]='slot-front' ;
                                                        slotClasses[2]='slot-front' ; slotClasses[4]='slot-front' ; }
                                                        else if(team.formation==='4-1' ) { slotClasses[0]='slot-front' ;
                                                        slotClasses[1]='slot-front' ; slotClasses[3]='slot-front' ;
                                                        slotClasses[4]='slot-front' ; } %>
                                                        <% team.hero_ids.forEach((hid, idx)=> { %>
                                                            <% let h=heroesMap[hid]; %>
                                                                <div class="hero-slot-visual <%= slotClasses[idx] %>">
                                                                    <% if(h) { %>
                                                                        <img src="/images/heroes/<%= h.image_name %>">
                                                                        <% } %>
                                                                </div>
                                                                <% }) %>

                                                                    <!-- Pet Slot Moved Here -->
                                                                    <div class="hero-slot-visual pet-slot"
                                                                        style="box-shadow: 0 0 10px rgba(255, 215, 0, 0.3); margin-left: clamp(5px, 2vw, 15px) !important; margin-right: 0 !important; border-color: #ffd700 !important;">
                                                                        <% if(team.pet_id) { %>
                                                                            <img src="/images/pets/<%= team.pet_id %>"
                                                                                title="Pet">
                                                                            <% } else { %>
                                                                                <div
                                                                                    class="d-flex align-items-center justify-content-center h-100 text-secondary">
                                                                                    <i class="bi bi-plus-lg"></i>
                                                                                </div>
                                                                                <% } %>
                                                                    </div>
                                                </div>
                                            </div>

                                            <div class="mb-3">
                                                <div class="skill-section-title">Skill Order</div>
                                                <div class="skill-section-container">
                                                    <% [2, 3].forEach(sIdx=> { %>
                                                        <div class="skill-fixed-row">
                                                            <% team.hero_ids.forEach((hid, heroIdx)=> { %>
                                                                <% let h=heroesMap[hid]; let fileName=`${sIdx}.png`; let
                                                                    orderKey=`${heroIdx}_${fileName}`; let
                                                                    orderIndex=-1; if(team.skill_priority &&
                                                                    team.skill_priority.includes(orderKey)) {
                                                                    orderIndex=team.skill_priority.indexOf(orderKey) +
                                                                    1; } let exists=(h && h.skills &&
                                                                    h.skills.includes(fileName)); %>
                                                                    <% if(h && exists) { %>
                                                                        <% let folder=h.skill_folder ||
                                                                            h.image_name.replace(/\.[^/.]+$/, "" ); %>
                                                                            <div
                                                                                class="skill-node <%= orderIndex > 0 ? 'has-order' : '' %>">
                                                                                <img src="/images/skill/<%= folder %>/<%= fileName %>"
                                                                                    onerror="this.style.opacity='0.1'">
                                                                                <% if(orderIndex> 0) { %>
                                                                                    <div class="skill-badge">
                                                                                        <%= orderIndex %>
                                                                                    </div>
                                                                                    <% } %>
                                                                            </div>
                                                                            <% } else { %>
                                                                                <div class="skill-node empty-slot">
                                                                                </div>
                                                                                <% } %>
                                                                                    <% }) %>
                                                        </div>
                                                        <% }) %>
                                                </div>
                                            </div>

                                            <% if(team.description) { %>
                                                <div class="desc-box">
                                                    <%= team.description %>
                                                </div>
                                                <% } %>

                                                    <div class="card-actions">
                                                        <button class="btn-capture-circle"
                                                            onclick="smartCapture('<%= team.id %>', '<%= activeRaid.displayName %>', '<%= team.team_name %>')">
                                                            <i class="bi bi-camera-fill"></i>
                                                        </button>
                                                    </div>
                                        </div>
                                    </div>
                                    <% }) %>
                    </div>
                </div>

                <div id="capture-staging-area" style="position:fixed; top:-9999px; left:-9999px;"></div>

                <script>
                    function smartCapture(teamId, raidName, teamName) {
                        const sourceCard = document.getElementById(`card-${teamId}`);
                        const staging = document.getElementById('capture-staging-area');
                        const btn = sourceCard.querySelector('.btn-capture-circle');

                        // 1. Loading
                        const originalIcon = btn.innerHTML;
                        btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span>';

                        // 2. Clone for Screenshot
                        const captureWrapper = document.createElement('div');
                        captureWrapper.className = 'capture-template-layout';

                        // Sidebar
                        const leftCol = document.createElement('div');
                        leftCol.className = 'capture-sidebar-col';
                        leftCol.innerHTML = `
                    <img src="/images/raid/<%= activeRaid.image_name %>">
                    <div class="capture-sidebar-title">${raidName}</div>
                `;
                        // Content
                        const rightCol = document.createElement('div');
                        rightCol.className = 'capture-content-col';

                        const headerClone = sourceCard.querySelector('.d-flex.justify-content-between').cloneNode(true);
                        const yt = headerClone.querySelector('a'); if (yt) yt.remove();

                        const fieldClone = sourceCard.querySelector('.battle-field').cloneNode(true);
                        const skillClone = sourceCard.querySelector('.mb-3').cloneNode(true);
                        const descClone = sourceCard.querySelector('.desc-box') ? sourceCard.querySelector('.desc-box').cloneNode(true) : null;

                        rightCol.appendChild(headerClone);
                        rightCol.appendChild(fieldClone);
                        rightCol.appendChild(skillClone);
                        if (descClone) rightCol.appendChild(descClone);
                        const watermark = document.createElement('div');
                        watermark.style.marginTop = 'auto'; watermark.style.color = '#444'; watermark.style.fontSize = '0.8rem'; watermark.innerText = '7K Rebirth Guide';
                        rightCol.appendChild(watermark);

                        captureWrapper.appendChild(leftCol);
                        captureWrapper.appendChild(rightCol);

                        staging.innerHTML = '';
                        staging.appendChild(captureWrapper);

                        // 3. Capture
                        setTimeout(() => {
                            html2canvas(captureWrapper, {
                                backgroundColor: '#15191d',
                                scale: 2,
                                logging: false
                            }).then(canvas => {
                                const link = document.createElement('a');
                                link.download = `Raid_${raidName}_${teamName}.png`;
                                link.href = canvas.toDataURL('image/png');
                                link.click();

                                staging.innerHTML = '';
                                btn.innerHTML = originalIcon;
                            }).catch(err => {
                                console.error(err);
                                alert('Error capturing');
                                btn.innerHTML = originalIcon;
                            });
                        }, 100);
                    }
                </script>
                <% } %>

                    <%- include('../partials/footer') %>
</body>

</html>